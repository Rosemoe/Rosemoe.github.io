<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>一个高亮编辑框的构建历程 | Rosemoe's Blog</title><meta name="keywords" content="Android,Java,自定义View"><meta name="author" content="Rosemoe"><meta name="copyright" content="Rosemoe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言制作背景我已经在这之前多次写过高亮编辑框了,自从我入门编程以来,就一直在尝试自己造个高亮编辑框的轮子。如果你不想看Rose无聊的背景叙述，请直接从侧栏跳到“本项目的开端”部分。    第一次尝试 - Editable原理这还是在我玩iApp的时候了。当时觉得一个高亮代码编辑框是iApp源码的一大空缺，所以打算造个源码。初次的尝试对Android原生的控件还是抱有很大的期望的。所以选用了Andr">
<meta property="og:type" content="article">
<meta property="og:title" content="一个高亮编辑框的构建历程">
<meta property="og:url" content="https://rosemoe.github.io/2020/02/15/highlight-editor-creation/index.html">
<meta property="og:site_name" content="Rosemoe&#39;s Blog">
<meta property="og:description" content="前言制作背景我已经在这之前多次写过高亮编辑框了,自从我入门编程以来,就一直在尝试自己造个高亮编辑框的轮子。如果你不想看Rose无聊的背景叙述，请直接从侧栏跳到“本项目的开端”部分。    第一次尝试 - Editable原理这还是在我玩iApp的时候了。当时觉得一个高亮代码编辑框是iApp源码的一大空缺，所以打算造个源码。初次的尝试对Android原生的控件还是抱有很大的期望的。所以选用了Andr">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png">
<meta property="article:published_time" content="2020-02-15T09:01:21.000Z">
<meta property="article:modified_time" content="2021-08-22T05:42:02.693Z">
<meta property="article:author" content="Rosemoe">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="自定义View">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://rosemoe.github.io/2020/02/15/highlight-editor-creation/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一个高亮编辑框的构建历程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-08-22 13:42:02'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Rosemoe's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">一个高亮编辑框的构建历程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2020-02-15T09:01:21.000Z" title="Created 2020-02-15 17:01:21">2020-02-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-08-22T05:42:02.693Z" title="Updated 2021-08-22 13:42:02">2021-08-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="一个高亮编辑框的构建历程"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="制作背景"><a href="#制作背景" class="headerlink" title="制作背景"></a>制作背景</h3><p>我已经在这之前多次写过高亮编辑框了,自从我入门编程以来,就一直在尝试自己造个高亮编辑框的轮子。<br>如果你不想看Rose无聊的背景叙述，请直接从侧栏跳到“本项目的开端”部分。   </p>
<h4 id="第一次尝试-Editable"><a href="#第一次尝试-Editable" class="headerlink" title="第一次尝试 - Editable"></a>第一次尝试 - Editable</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>这还是在我玩iApp的时候了。当时觉得一个高亮代码编辑框是iApp源码的一大空缺，所以打算造个源码。<br>初次的尝试对Android原生的控件还是抱有很大的期望的。所以选用了Android自带的TextView来制作。<br>众所周知，<code>TextView</code>自己就能显示不同颜色的文本，比如经常看到的链接就是一个例子。所以<code>TextView</code>拿来玩，<br>不存在原理上的问题。<br>因此，我们用<code>Editable</code>来设置文本颜色Spans，并且用<code>TextView</code>显示就好了。我们在文本更新时对高亮进行更新。<br>至于行号，我们只需要编辑框的左边加一个<code>TextView</code>就好了，然后在文本改变时生成文本设置就好了。<br>而滚动，只需要<code>ScrollView</code>和<code>HorizontalScrollView</code>套娃就行了。<br>再者，Spans的匹配只需要轻轻地写个正则表达式<code>Pattern</code> + <code>Matcher</code>就可以匹配了。 </p>
<h5 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h5><p>于是我们造出了第一个高亮编辑框。这个编辑框比较原始，因为遇到一些转义的写法，字符串的高亮就可能发生错乱。下面是用于高亮SpannableStringBuilder的方法(Editable的唯一自带实现类)。代码只给出了一个类中的重要部分，自行移植。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关键字，用|隔开</span></span><br><span class="line"><span class="keyword">private</span> String mBaseword = <span class="string">&quot;instanceof|throw(s)?|new|continue|super|this|interface|abstract|public|private|protected|break|for|while|default|class|extends|implements|float|double|import|package|try|catch|finally|final|if|else|do|void|return|case|switch|null|false|true|static|int|byte|long|short&quot;</span>;</span><br><span class="line"><span class="comment">//类名，用|隔开</span></span><br><span class="line"><span class="keyword">private</span> String mKeyword = <span class="string">&quot;Override|Runnable|Thread|Activity|Context|Object|Integer|String|StringBuilder|CharSequence|Exception|Long|Short|Double|Float|Byte|Void&quot;</span>;</span><br><span class="line"><span class="comment">//关键字颜色</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mBasewordColor = Color.parseColor(<span class="string">&quot;#E91E63&quot;</span>);</span><br><span class="line"><span class="comment">//类名颜色</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mKeywordColor = Color.parseColor(<span class="string">&quot;#2196F3&quot;</span>);</span><br><span class="line"><span class="comment">//数字颜色</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mNumberColor = mBasewordColor;</span><br><span class="line"><span class="comment">//字符串颜色</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mStringColor = mNumberColor;</span><br><span class="line"><span class="comment">//注释颜色</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> mCommentColor = Color.parseColor(<span class="string">&quot;#9e9e9e&quot;</span>);</span><br><span class="line"><span class="comment">//没什么，用于连接字符串，编译关键字正则和类名正则</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Pattern <span class="title">getPattern</span><span class="params">(String content)</span></span>&#123;<span class="keyword">return</span> Pattern.compile(<span class="string">&quot;\\b(&quot;</span>+content+<span class="string">&quot;)\\b&quot;</span>);&#125;</span><br><span class="line"><span class="comment">//关键字正则</span></span><br><span class="line"><span class="keyword">private</span> Pattern mBasewordPattern = getPattern(mBaseword);</span><br><span class="line"><span class="comment">//类名正则</span></span><br><span class="line"><span class="keyword">private</span> Pattern mKeywordPattern = getPattern(mKeyword);</span><br><span class="line"><span class="comment">//字符串正则</span></span><br><span class="line"><span class="keyword">private</span> Pattern mStringPattern = Pattern.compile(<span class="string">&quot;\\\&quot;(.*?)\\\&quot;|\\\&#x27;(.*?)\\\&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//数字正则</span></span><br><span class="line"><span class="keyword">private</span> Pattern mNumberPattern = Pattern.compile(<span class="string">&quot;\\b(\\d*[.]?\\d+[|L|F|l|f]*)\\b&quot;</span>);</span><br><span class="line"><span class="comment">//注释正则</span></span><br><span class="line"><span class="keyword">private</span> Pattern mCommentPattern = Pattern.compile(<span class="string">&quot;(\\/\\/.*|\\/\\*[\\s\\S]*?\\*\\/)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//对于指定的SpannableStringBuilder进行高亮处理</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">highlight</span><span class="params">(SpannableStringBuilder sb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(sb.length() == <span class="number">0</span>)<span class="comment">//如果是空，就取消高亮</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    clearSpans(sb);<span class="comment">//清除spans</span></span><br><span class="line">    <span class="keyword">for</span>(Matcher m = mBasewordPattern.matcher(sb);m.find();)</span><br><span class="line">      sb.setSpan(<span class="keyword">new</span> ForegroundColorSpan(mBasewordColor),m.start(),m.end(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    <span class="keyword">for</span>(Matcher m = mKeywordPattern.matcher(sb);m.find();)</span><br><span class="line">      sb.setSpan(<span class="keyword">new</span> ForegroundColorSpan(mKeywordColor),m.start(),m.end(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    <span class="keyword">for</span>(Matcher m = mNumberPattern.matcher(sb);m.find();)</span><br><span class="line">      sb.setSpan(<span class="keyword">new</span> ForegroundColorSpan(mBasewordColor),m.start(),m.end(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    <span class="keyword">for</span> (Matcher m = mStringPattern.matcher(sb); m.find();)</span><br><span class="line">    &#123;</span><br><span class="line">        ForegroundColorSpan[] spans = sb.getSpans(m.start(), m.end(), ForegroundColorSpan.class);</span><br><span class="line">        <span class="keyword">for</span> (ForegroundColorSpan span : spans)</span><br><span class="line">          sb.removeSpan(span);</span><br><span class="line">       sb.setSpan(<span class="keyword">new</span> ForegroundColorSpan(mStringColor), m.start(), m.end(), Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(Matcher m = mCommentPattern.matcher(sb);m.find();)</span><br><span class="line">      sb.setSpan(<span class="keyword">new</span> ForegroundColorSpan(mCommentColor),m.start(),m.end(),Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">  &#125;<span class="keyword">catch</span>(Exception e)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面给出用于自动在回车时加入空格时的代码。同样只给出关键部分和方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setupAutoIndent</span><span class="params">(EditText et)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  InputFilter[] ifs = <span class="keyword">new</span> InputFilter[]&#123;</span><br><span class="line">    <span class="keyword">new</span> InputFilter()</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> CharSequence <span class="title">filter</span><span class="params">(CharSequence source, <span class="keyword">int</span> start, <span class="keyword">int</span> end, Spanned dest, <span class="keyword">int</span> dstart, <span class="keyword">int</span> dend)</span></span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (end - start == <span class="number">1</span> &amp;&amp; start &lt; source.length() &amp;&amp; dstart &lt; dest.length())</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">char</span> c = source.charAt(start);</span><br><span class="line">          <span class="keyword">if</span>(c == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> autoIndent(source,dest,dstart,dend);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;&#125;;</span><br><span class="line">  et.setFilters(ifs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> CharSequence <span class="title">autoIndent</span><span class="params">(CharSequence source,Spanned dest,<span class="keyword">int</span> dstart,<span class="keyword">int</span> dend)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  String indent = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">int</span> istart = dstart - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">boolean</span> dataBefore = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">int</span> pt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; istart &gt; -<span class="number">1</span>; --istart)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> c = dest.charAt(istart);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="string">&#x27; &#x27;</span> &amp;&amp;c != <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (!dataBefore)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;&#123;&#x27;</span> ||c == <span class="string">&#x27;+&#x27;</span> ||c == <span class="string">&#x27;-&#x27;</span> ||c == <span class="string">&#x27;*&#x27;</span> ||c == <span class="string">&#x27;/&#x27;</span> ||c == <span class="string">&#x27;%&#x27;</span> ||c == <span class="string">&#x27;^&#x27;</span> ||c == <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">          pt--;</span><br><span class="line">        dataBefore = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (c == <span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">        --pt;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">        ++pt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (istart &gt; -<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> charAtCursor = dest.charAt(dstart);</span><br><span class="line">    <span class="keyword">int</span> iend;</span><br><span class="line">    <span class="keyword">for</span> (iend = ++istart;iend &lt; dend;++iend)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> c = dest.charAt(iend);</span><br><span class="line">      <span class="keyword">if</span> (charAtCursor != <span class="string">&#x27;\n&#x27;</span> &amp;&amp;c == <span class="string">&#x27;/&#x27;</span> &amp;&amp;iend + <span class="number">1</span> &lt; dend &amp;&amp;dest.charAt(iend) == c)</span><br><span class="line">      &#123;</span><br><span class="line">        iend += <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (c != <span class="string">&#x27; &#x27;</span> &amp;&amp;c != <span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line">   indent += dest.subSequence(istart, iend);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pt &lt; <span class="number">0</span>)</span><br><span class="line">    indent += <span class="string">&quot;\t&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> source + indent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>毕竟我们并没有真正的对它的语法进行分析，仅仅是正则匹配了一下而已。不但如此，虽然它在文本很少的时候效率很高，<br>我们使用起来就好像根本没有延迟一样，但是我们发现，文本一大，高亮的刷新就要很久，而且，由于我们在<code>TextWatcher#afterTextChanged(Editable)</code>中做我们的高亮刷新逻辑，实际上还是在UI线程，文本大了直接就把主线程给堵住了，用户无法进行交互，这无疑是最为恶劣的行径了。<br>我尝试在非主线程中刷新高亮，但是问题出现了–程序闪退了。<br>查看日志，原来<code>TextView</code>已经注册了<code>SpanWatcher</code>，当<code>Editable</code>中的Spans改变时，会导致<code>TextView</code>更新它的视图。<br>所以，当你在非UI线程对Spans进行修改时，会抛出来自<code>ViewRootImple#checkThread()</code>的异常，以阻止你非法更新视图。<br>总的来说，这一次已经实现了基本的高亮功能，但是存在诸多的弊端，尤其是用户体验不佳，所以该项目不佳。</p>
<h5 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h5><ul>
<li>高亮更新容易卡顿，并且可能错误</li>
<li>行号更新需要较多时间</li>
<li>滑动不顺畅，且不便于布局</li>
<li>每次增加一个Span都要重绘一次，资源占用高    </li>
</ul>
<h3 id="第二次尝试-自定义View的开端"><a href="#第二次尝试-自定义View的开端" class="headerlink" title="第二次尝试 - 自定义View的开端"></a>第二次尝试 - 自定义View的开端</h3><h4 id="翻看开源项目"><a href="#翻看开源项目" class="headerlink" title="翻看开源项目"></a>翻看开源项目</h4><p>经过上一次尝试的失败后，我前去翻阅了TextWarrior（文侠）项目的源码（由于AndroLua+的使用，现在多数人称之为<code>LuaEditor</code>了，我也是在GitHub开源的Androlua-pro项目里面查看的）<br>无奈，看到关键的高亮部分却是看不懂了，打开<code>LuaLexer</code>我就傻眼了：这一大堆字符串常量都是些什么啊？还一堆什么什么静态的<code>UnpackXxx()</code>的方法，<code>yylex()</code>方法更是又臭又长,而且一堆case。于是我关闭了文件。<br>看不懂源码的我只能闭门造车，经过在CSDN、简书等地的多日学习，我总算摸明白了自定义View的套路。于是开始弄自己的编辑框。</p>
<h4 id="闭门造车"><a href="#闭门造车" class="headerlink" title="闭门造车"></a>闭门造车</h4><p>然而，迫于当时自身技术所限，没能完成最终代码编辑框。仅仅是造了一个能显示文本和行号的编辑框而已，而且在翻动过程中，由于Index缓存算法的问题，可能随时抛出异常（必须的，当时我都没有考虑到文本的变化，所以如果编辑在显示区域之前的文本，必然在某时刻导致崩溃）。<br>本项目失败。</p>
<h3 id="第三次尝试"><a href="#第三次尝试" class="headerlink" title="第三次尝试"></a>第三次尝试</h3><p>不哔哔那么多，和第二次差不多了。但是能够流畅地显示大文本了，高达1000万行时不会出现绘制偏差了（经过查实，是float的精度问题，换成int就解决了）。<br>本次还添加了<code>UndoManager</code>用于管理Undo、Redo。顺便加了选择手柄，但是体验不佳。<br>重要的是，在这期间我可算知道了用于词法分析的工具–JFLex。<br>JFLex能够用正则表达式分析词法，给出一个词汇流。<br>我们不需要直接书写Java代码，而只需要写flex文件定义语法即可。</p>
<h3 id="总结经验"><a href="#总结经验" class="headerlink" title="总结经验"></a>总结经验</h3><ul>
<li>Android原生的控件因为兼容性的关系，不能够很好地显示高亮代码（或者很麻烦），我们倾向于使用自定义View来显示它</li>
<li>高亮我们需要一个词法分析器来分析词法，才能绝对正确地识别文本的用法</li>
<li>float不能处理行数高于1.2kw左右的情况，会导致绘制的行位置产生偏差，大约每5行为一个误差周期</li>
</ul>
<h2 id="本项目的开端"><a href="#本项目的开端" class="headerlink" title="本项目的开端"></a>本项目的开端</h2><p>在高一上学期期间，即2019年下半年，我死磕再一次写起了代码编辑框，这一次的原始想法是造一个Android IDE。<br>我在Eclipse建立了”EditorBase”工程,创建了<code>ITextContent</code>接口继承<code>CharSequence</code>，然后写了N个文件用ArrayList+StringBuilder的方式保存文本内容，实现了Insert、Delete和Replace操作，其中Replace直接调用Insert和Delete实现。UndoManager也重复实现了一遍。<br>本文含有大量源代码，懒得看的请点击语言左边的小按钮收起。</p>
<h3 id="按行保存文本"><a href="#按行保存文本" class="headerlink" title="按行保存文本"></a>按行保存文本</h3><p>主要是Insert、Delete。<br>其中的<code>Cursor</code>是稍后Android部分用到的工具，用于控制游标。<br>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">int</span> column, CharSequence text)</span> </span>&#123;</span><br><span class="line">        checkLineAndColumn(line, column, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;text can not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//-----Notify------</span></span><br><span class="line">        <span class="keyword">if</span>(_cursor != <span class="keyword">null</span>)</span><br><span class="line">            _cursor.beforeInsert(line,column,text.length());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> workLine = line;</span><br><span class="line">        <span class="keyword">int</span> workIndex = column;</span><br><span class="line">        <span class="keyword">if</span>(workIndex == -<span class="number">1</span>)&#123;</span><br><span class="line">            workIndex = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder currLine = _lines.get(workLine);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; text.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> c = text.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                StringBuilder newLine = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                newLine.append(currLine, workIndex, currLine.length());</span><br><span class="line">                currLine.delete(workIndex, currLine.length());</span><br><span class="line">                _lines.add(workLine + <span class="number">1</span>, newLine);</span><br><span class="line">                currLine = newLine;</span><br><span class="line">                workIndex = <span class="number">0</span>;</span><br><span class="line">                workLine++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currLine.insert(workIndex, c);</span><br><span class="line">                workIndex++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _textLength += text.length();</span><br><span class="line">        <span class="keyword">this</span>.dispatchAfterInsert(line, column, workLine, workIndex, text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> startLine, <span class="keyword">int</span> columnOnStartLine, <span class="keyword">int</span> endLine, <span class="keyword">int</span> columnOnEndLine)</span> </span>&#123;</span><br><span class="line">        StringBuilder changedContent = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">if</span> (startLine == endLine) &#123;</span><br><span class="line">            checkLineAndColumn(endLine, columnOnEndLine, <span class="keyword">true</span>);</span><br><span class="line">            checkLineAndColumn(startLine, columnOnStartLine == -<span class="number">1</span> ? <span class="number">0</span> : columnOnStartLine, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">int</span> beginIdx = columnOnStartLine;</span><br><span class="line">            <span class="keyword">int</span> endIdx = columnOnEndLine;</span><br><span class="line">            <span class="keyword">if</span> (columnOnStartLine == -<span class="number">1</span>) &#123;</span><br><span class="line">                beginIdx = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (beginIdx &gt; endIdx) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;start &gt; end&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder curr = _lines.get(startLine);</span><br><span class="line">            <span class="keyword">int</span> len = curr.length();</span><br><span class="line">            <span class="keyword">if</span> (beginIdx &lt; <span class="number">0</span> || endIdx &lt; <span class="number">0</span> || beginIdx &gt; len || endIdx &gt; len) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(<span class="string">&quot;column start or column end is out of bounds&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//-----Notify------</span></span><br><span class="line">            <span class="keyword">if</span>(_cursor != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">if</span>(columnOnStartLine != -<span class="number">1</span>)</span><br><span class="line">                    _cursor.beforeDelete(startLine,columnOnStartLine,endLine,columnOnEndLine);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    _cursor.beforeDelete(startLine == <span class="number">0</span> ? <span class="number">0</span> : startLine - <span class="number">1</span>,startLine == <span class="number">0</span> ? <span class="number">0</span> : getColumnCount(startLine - <span class="number">1</span>),endLine,columnOnEndLine);</span><br><span class="line"></span><br><span class="line">            changedContent.append(curr, beginIdx, endIdx);</span><br><span class="line">            curr.delete(beginIdx, endIdx);</span><br><span class="line">            _textLength -= columnOnEndLine - columnOnStartLine;</span><br><span class="line">            <span class="keyword">if</span> (columnOnStartLine == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (startLine == <span class="number">0</span>) &#123;</span><br><span class="line">                    _textLength++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    StringBuilder previous = _lines.get(startLine - <span class="number">1</span>);</span><br><span class="line">                    previous.append(curr);</span><br><span class="line">                    _lines.remove(startLine);</span><br><span class="line">                    changedContent.insert(<span class="number">0</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">                    startLine--;</span><br><span class="line">                    columnOnStartLine = getColumnCount(startLine);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (startLine &lt; endLine) &#123;</span><br><span class="line">            checkLineAndColumn(startLine, columnOnStartLine, <span class="keyword">true</span>);</span><br><span class="line">            checkLineAndColumn(endLine, columnOnEndLine, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//-----Notify------</span></span><br><span class="line">            <span class="keyword">if</span>(_cursor != <span class="keyword">null</span>)</span><br><span class="line">                _cursor.beforeDelete(startLine,columnOnStartLine,endLine,columnOnEndLine);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> currEnd = endLine;</span><br><span class="line">            <span class="keyword">while</span> (currEnd - <span class="number">1</span> != startLine) &#123;</span><br><span class="line">                StringBuilder line = _lines.remove(currEnd - <span class="number">1</span>);</span><br><span class="line">                _textLength -= line.length() + <span class="number">1</span>;</span><br><span class="line">                changedContent.append(<span class="string">&#x27;\n&#x27;</span>).append(line);</span><br><span class="line">                currEnd--;</span><br><span class="line">            &#125;</span><br><span class="line">            StringBuilder start = _lines.get(startLine);</span><br><span class="line">            StringBuilder end = _lines.get(currEnd);</span><br><span class="line">            _textLength -= start.length() - columnOnStartLine;</span><br><span class="line">            changedContent.insert(<span class="number">0</span>, start, columnOnStartLine, start.length());</span><br><span class="line">            start.delete(columnOnStartLine, start.length());</span><br><span class="line">            _textLength -= columnOnEndLine;</span><br><span class="line">            changedContent.append(<span class="string">&#x27;\n&#x27;</span>).append(end, <span class="number">0</span>, columnOnEndLine);</span><br><span class="line">            end.delete(<span class="number">0</span>, columnOnEndLine);</span><br><span class="line">            _textLength--;</span><br><span class="line">            _lines.remove(currEnd);</span><br><span class="line">            start.append(end);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;start line &gt; end line&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.dispatchAfterDelete(startLine, columnOnStartLine, endLine, columnOnEndLine, changedContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">replace</span><span class="params">(<span class="keyword">int</span> startLine, <span class="keyword">int</span> columnOnStartLine, <span class="keyword">int</span> endLine, <span class="keyword">int</span> columnOnEndLine, CharSequence text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;text can not be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.dispatchBeforeReplace();</span><br><span class="line">        delete(startLine, columnOnStartLine, endLine, columnOnEndLine);</span><br><span class="line">        insert(startLine, columnOnStartLine, text);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现Index-lt-gt-Line-Column-的变换"><a href="#实现Index-lt-gt-Line-Column-的变换" class="headerlink" title="实现Index&lt;-&gt;(Line,Column)的变换"></a>实现Index&lt;-&gt;(Line,Column)的变换</h3><p>它的精彩之处不在于保存文本的方式，而在于index和行列对的转换。<br>我们使用了Indexer接口定义转换器。它拥有多个实现，包括：<code>CachedIndexer</code>和<code>NoCacheIndexer</code>。<code>NoCacheIndex</code>直接继承<code>CachedIndexer</code>并且关闭缓存即可。<br><code>CachedIndexer</code>可以监听文本内容的变化。<br>这是<code>CachedIndexer</code>的部分代码（不关键的部分已删去）。主要是从缓存进行查询的步骤可以看一看。<br>其中更新缓存的代码可能有误，请到仓库查看最新实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedIndexer</span> <span class="keyword">implements</span> <span class="title">Indexer</span>,<span class="title">ContentListener</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Content _c;</span><br><span class="line">    <span class="keyword">private</span> CharPosition _zero = <span class="keyword">new</span> CharPosition().zero();</span><br><span class="line">    <span class="keyword">private</span> List&lt;CharPosition&gt; _cache = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _switchIndex = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _switchLine = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _maxSize = <span class="number">50</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> CharPosition <span class="title">findIndexForward</span><span class="params">(CharPosition start,<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(start.index &gt; index) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to find backward from method findIndexForward()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> workLine = start.line;</span><br><span class="line">        <span class="keyword">int</span> workColumn = start.column;</span><br><span class="line">        <span class="keyword">int</span> workIndex = start.index;</span><br><span class="line">        <span class="comment">//Move the column to the line end</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> column = _c.getColumnCount(workLine);</span><br><span class="line">            workIndex += column - workColumn;</span><br><span class="line">            workColumn = column;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(workIndex &lt; index) &#123;</span><br><span class="line">            workLine++;</span><br><span class="line">            workColumn = _c.getColumnCount(workLine);</span><br><span class="line">            workIndex += workColumn + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(workIndex &gt; index) &#123;</span><br><span class="line">            workColumn -= workIndex - index;</span><br><span class="line">        &#125;</span><br><span class="line">        CharPosition pos = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        pos.column = workColumn;</span><br><span class="line">        pos.line = workLine;</span><br><span class="line">        pos.index = index;</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CharPosition <span class="title">findIndexBackward</span><span class="params">(CharPosition start,<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(start.index &lt; index) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to find forward from method findIndexBackward()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> workLine = start.line;</span><br><span class="line">        <span class="keyword">int</span> workColumn = start.column;</span><br><span class="line">        <span class="keyword">int</span> workIndex = start.index;</span><br><span class="line">        <span class="keyword">while</span>(workIndex &gt; index) &#123;</span><br><span class="line">            workIndex -= workColumn + <span class="number">1</span>;</span><br><span class="line">            workLine--;</span><br><span class="line">            <span class="keyword">if</span>(workLine != -<span class="number">1</span>) &#123;</span><br><span class="line">                workColumn = _c.getColumnCount(workLine);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//Reached the start of text,we have to use findIndexForward() as this method can not handle it</span></span><br><span class="line">                <span class="keyword">return</span> findIndexForward(_zero,index);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> dColumn = index - workIndex;</span><br><span class="line">        <span class="keyword">if</span>(dColumn &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            workLine++;</span><br><span class="line">            workColumn = dColumn - <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CharPosition pos = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        pos.column = workColumn;</span><br><span class="line">        pos.line = workLine;</span><br><span class="line">        pos.index = index;</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CharPosition <span class="title">findLiCoForward</span><span class="params">(CharPosition start,<span class="keyword">int</span> line,<span class="keyword">int</span> column)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(start.line &gt; line) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;can not find backward from findLiCoForward()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> workLine = start.line;</span><br><span class="line">        <span class="keyword">int</span> workIndex = start.index;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Make index to to left of line</span></span><br><span class="line">            workIndex = workIndex - start.column;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(workLine &lt; line) &#123;</span><br><span class="line">            workIndex += _c.getColumnCount(workLine) + <span class="number">1</span>;</span><br><span class="line">            workLine ++;</span><br><span class="line">        &#125;</span><br><span class="line">        CharPosition pos = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        pos.column = <span class="number">0</span>;</span><br><span class="line">        pos.line = workLine;</span><br><span class="line">        pos.index = workIndex;</span><br><span class="line">        <span class="keyword">return</span> findInLine(pos, line, column);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CharPosition <span class="title">findLiCoBackward</span><span class="params">(CharPosition start,<span class="keyword">int</span> line,<span class="keyword">int</span> column)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(start.line &lt; line) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;can not find forward from findLiCoBackward()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> workLine = start.line;</span><br><span class="line">        <span class="keyword">int</span> workIndex = start.index;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Make index to the left of line</span></span><br><span class="line">            workIndex = workIndex - start.column;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(workLine &gt; line) &#123;</span><br><span class="line">            workIndex -= _c.getColumnCount(workLine - <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">            workLine--;</span><br><span class="line">        &#125;</span><br><span class="line">        CharPosition pos = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        pos.column = <span class="number">0</span>;</span><br><span class="line">        pos.line = workLine;</span><br><span class="line">        pos.index = workIndex;</span><br><span class="line">        <span class="keyword">return</span> findInLine(pos, line, column);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> CharPosition <span class="title">findInLine</span><span class="params">(CharPosition pos,<span class="keyword">int</span> line,<span class="keyword">int</span> column)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(pos.line != line) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;can not find other lines with findInLine()&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> index = pos.index - pos.column + column;</span><br><span class="line">        CharPosition pos2 = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        pos2.column = column;</span><br><span class="line">        pos2.line = line;</span><br><span class="line">        pos2.index = index;</span><br><span class="line">        <span class="keyword">return</span> pos2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharPosition <span class="title">getCharPosition</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        _throw();</span><br><span class="line">        _c.checkIndex(index);</span><br><span class="line">        CharPosition pos = findNeareatByIndex(index);</span><br><span class="line">        CharPosition res;</span><br><span class="line">        <span class="keyword">if</span>(pos.index == index) &#123;</span><br><span class="line">            <span class="keyword">return</span> pos;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos.index &lt; index) &#123;</span><br><span class="line">            res = findIndexForward(pos, index);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            res = findIndexBackward(pos, index);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(Math.abs(index - pos.index) &gt;= _switchIndex) &#123;</span><br><span class="line">            push(res);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharPosition <span class="title">getCharPosition</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">int</span> column)</span> </span>&#123;</span><br><span class="line">        _throw();</span><br><span class="line">        _c.checkLineAndColumn(line, column, <span class="keyword">true</span>);</span><br><span class="line">        CharPosition pos = findNeareastByLine(line);</span><br><span class="line">        CharPosition res;</span><br><span class="line">        <span class="keyword">if</span>(pos.line == line) &#123;</span><br><span class="line">            <span class="keyword">if</span>(pos.column == column) &#123;</span><br><span class="line">                <span class="keyword">return</span> pos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> findInLine(pos,line,column);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos.line &lt; line) &#123;</span><br><span class="line">            res = findLiCoForward(pos, line, column);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            res = findLiCoBackward(pos, line, column);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(Math.abs(pos.line - line) &gt; _switchLine) &#123;</span><br><span class="line">            push(res);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterInsert</span><span class="params">(Content content, <span class="keyword">int</span> startLine, <span class="keyword">int</span> startColumn, <span class="keyword">int</span> endLine, <span class="keyword">int</span> endColumn,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CharSequence insertedContent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isHandleEvent()) &#123;</span><br><span class="line">            <span class="keyword">for</span>(CharPosition pos : _cache) &#123;</span><br><span class="line">                <span class="keyword">if</span>(pos.line == startLine)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (pos.column &gt;= startColumn) &#123;</span><br><span class="line">                        pos.index += insertedContent.length();</span><br><span class="line">                        pos.line += endLine - startLine;</span><br><span class="line">                        pos.column = endColumn + pos.column - startColumn;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos.line &gt; startLine) &#123;</span><br><span class="line">                    pos.index += insertedContent.length();</span><br><span class="line">                    pos.line += endLine - startLine;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _detectException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterDelete</span><span class="params">(Content content, <span class="keyword">int</span> startLine, <span class="keyword">int</span> startColumn, <span class="keyword">int</span> endLine, <span class="keyword">int</span> endColumn,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CharSequence deletedContent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isHandleEvent()) &#123;</span><br><span class="line">            List&lt;CharPosition&gt; garbbages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span>(CharPosition pos : _cache) &#123;</span><br><span class="line">                <span class="keyword">if</span>(pos.line == startLine) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(pos.column &gt;= startColumn)</span><br><span class="line">                        garbbages.add(pos);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos.line &gt; startLine) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(pos.line &lt; endLine) &#123;</span><br><span class="line">                        garbbages.add(pos);</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(pos.line == endLine) &#123;</span><br><span class="line">                        garbbages.add(pos);</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        pos.index -= deletedContent.length();</span><br><span class="line">                        pos.line -= endLine - startLine;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            _cache.removeAll(garbbages);</span><br><span class="line">            garbbages.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        _detectException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本次的意义在于从基层实现了(Line,Column)与Index的互查，仍然采用的是缓存来加速，但实现了更新缓存的逻辑。（尽管很弱）</p>
<h3 id="Undo和Redo"><a href="#Undo和Redo" class="headerlink" title="Undo和Redo"></a>Undo和Redo</h3><p>Undo/Redo功能也适宜在最底层实现了。我们使用<code>UndoManager</code>来管理这些操作。<br>我们知道，用户输入文本总是一点一点地输入的，如果每一次修改都记录的话，那么要恢复操作的时候肯定Undo、Redo就得被狂按了。<br>所以，我们必须合并这些操作。而且，我们保存的操作不能太多，要不然用户多写一堆东西，咱们可就OOM喽！<br>所以，我们为Stack设定一个最大大小。<br>此外，输入法还有功能是批量操作。典型例子就是当你接入外接键盘到你的手机上的时候，你的输入法会变成一条。这个时候，你输入的拼音不是显示在你的输入法窗口中而是直接就显示在了我们的输入框里面。在输入法把拼音提交给输入框之前，会先通过<code>InputConnection#beginBatchEdit()</code>来通知你开始批量输入，这个方法的返回值是boolean。如果你在这个时候返回false，那拼音就输入不了了喽！而且输入法会变成只能输入英文和符号了！！！典型的例子就是AIDE了，在我的凤凰OS上就只能输入英文，如果想输入中文，我就只能复制粘贴了。所以，实现<code>beginBatchEdit()</code>和<code>endBatchEdit()</code>是有必要的。<br><strong>在我们继承的BaseInputConnection中，<code>beginBachEdit()</code>和<code>endBatchEdit()</code>都是空实现!</strong><br><strong>根据Android开发文档，batchEdit可以嵌套，而且在<code>endBatchEdit()</code>方法中,有些”behave”不良的输入法可能到导致我们的nestedBatchEdit数值小于0,这个时候,你不能让它小于0!而在<code>finishComposingText()</code>中你必须结束所有的BatchEdit</strong><br>在batchEdit时,我们应该合并所有操作为一个操作。<br>以上方法均在<code>InputConnection</code>中定义过了，可以参阅。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UndoManager</span> <span class="keyword">implements</span> <span class="title">ContentListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Content _c;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> _undoEnabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _maxStackSize;</span><br><span class="line">    <span class="keyword">private</span> List&lt;ContentAction&gt; _undoStack;</span><br><span class="line">    <span class="keyword">private</span> InsertAction _insertAction;</span><br><span class="line">    <span class="keyword">private</span> DeleteAction _deleteAction;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> _replace;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> _undoPos;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> _ignore;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">UndoManager</span><span class="params">(Content content)</span> </span>&#123;</span><br><span class="line">        _c = content;</span><br><span class="line">        _undoStack = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        _replace = <span class="keyword">false</span>;</span><br><span class="line">        _insertAction = <span class="keyword">null</span>;</span><br><span class="line">        _deleteAction = <span class="keyword">null</span>;</span><br><span class="line">        _undoPos = <span class="number">0</span>;</span><br><span class="line">        _ignore = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">undo</span><span class="params">(Content content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(canUndo()) &#123;</span><br><span class="line">            _ignore = <span class="keyword">true</span>;</span><br><span class="line">            _undoStack.get(_undoPos - <span class="number">1</span>).undo(content);</span><br><span class="line">            _undoPos--;</span><br><span class="line">            _ignore = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redo</span><span class="params">(Content content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(canRedo()) &#123;</span><br><span class="line">            _ignore = <span class="keyword">true</span>;</span><br><span class="line">            _undoStack.get(_undoPos).redo(content);</span><br><span class="line">            _undoPos++;</span><br><span class="line">            _ignore = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canUndo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isUndoEnabled() &amp;&amp; (_undoPos &gt; <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canRedo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isUndoEnabled() &amp;&amp; (_undoPos &lt; _undoStack.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUndoEnabled</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">        _undoEnabled = enabled;</span><br><span class="line">        <span class="keyword">if</span> (!enabled) &#123;</span><br><span class="line">            cleanStack();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUndoEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _undoEnabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxUndoStackSize</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">&quot;max size can not be zero or smaller.Did you want to disable undo module by calling set_undoEnabled(false)?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        _maxStackSize = maxSize;</span><br><span class="line">        cleanStack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxUndoStackSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _maxStackSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!_undoEnabled) &#123;</span><br><span class="line">            _undoStack.clear();</span><br><span class="line">            _undoPos = <span class="number">0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(_undoPos &gt; <span class="number">1</span> &amp;&amp; _undoStack.size() &gt; _maxStackSize) &#123;</span><br><span class="line">                _undoStack.remove(<span class="number">0</span>);</span><br><span class="line">                _undoPos--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanBeforePush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(_undoPos &lt; _undoStack.size()) &#123;</span><br><span class="line">            _undoStack.remove(_undoStack.size() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">_push</span><span class="params">(ContentAction action)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isUndoEnabled()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cleanBeforePush();</span><br><span class="line">        <span class="keyword">if</span>(_c.isInBatchEdit()) &#123;</span><br><span class="line">            <span class="keyword">if</span>(_undoStack.isEmpty()) &#123;</span><br><span class="line">                MultiAction a = <span class="keyword">new</span> MultiAction();</span><br><span class="line">                a.addAction(action);</span><br><span class="line">                _undoStack.add(a);</span><br><span class="line">                _undoPos++;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                ContentAction a = _undoStack.get(_undoStack.size() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(a <span class="keyword">instanceof</span> MultiAction) &#123;</span><br><span class="line">                    MultiAction ac = (MultiAction)a;</span><br><span class="line">                    ac.addAction(action);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    MultiAction ac = <span class="keyword">new</span> MultiAction();</span><br><span class="line">                    ac.addAction(action);</span><br><span class="line">                    _undoStack.add(ac);</span><br><span class="line">                    _undoPos++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(_undoStack.isEmpty()) &#123;</span><br><span class="line">                _undoStack.add(action);</span><br><span class="line">                _undoPos++;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                ContentAction last = _undoStack.get(_undoStack.size() - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(last.canMerge(action)) &#123;</span><br><span class="line">                    last.merge(action);</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    _undoStack.add(action);</span><br><span class="line">                    _undoPos++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cleanStack();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeReplace</span><span class="params">(Content content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(_ignore) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _replace = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterInsert</span><span class="params">(Content content, <span class="keyword">int</span> startLine, <span class="keyword">int</span> startColumn, <span class="keyword">int</span> endLine, <span class="keyword">int</span> endColumn,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CharSequence insertedContent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(_ignore) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _insertAction = <span class="keyword">new</span> InsertAction();</span><br><span class="line">        _insertAction.startLine = startLine;</span><br><span class="line">        _insertAction.startColumn = startColumn;</span><br><span class="line">        _insertAction.endLine = endLine;</span><br><span class="line">        _insertAction.endColumn = endColumn;</span><br><span class="line">        _insertAction.text = insertedContent;</span><br><span class="line">        <span class="keyword">if</span>(_replace) &#123;</span><br><span class="line">            ReplaceAction rep = <span class="keyword">new</span> ReplaceAction();</span><br><span class="line">            rep._delete = _deleteAction;</span><br><span class="line">            rep._insert = _insertAction;</span><br><span class="line">            _push(rep);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            _push(_insertAction);</span><br><span class="line">        &#125;</span><br><span class="line">        _replace = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterDelete</span><span class="params">(Content content, <span class="keyword">int</span> startLine, <span class="keyword">int</span> startColumn, <span class="keyword">int</span> endLine, <span class="keyword">int</span> endColumn,</span></span></span><br><span class="line"><span class="params"><span class="function">                            CharSequence deletedContent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(_ignore) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        _deleteAction = <span class="keyword">new</span> DeleteAction();</span><br><span class="line">        _deleteAction.endColumn = endColumn;</span><br><span class="line">        _deleteAction.startColumn = startColumn;</span><br><span class="line">        _deleteAction.endLine = endLine;</span><br><span class="line">        _deleteAction.startLine = startLine;</span><br><span class="line">        _deleteAction.text = deletedContent;</span><br><span class="line">        <span class="keyword">if</span>(!_replace) &#123;</span><br><span class="line">            _push(_deleteAction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有应该实现的基础至此都已实现，剩下的就是Android部分了。</p>
<h2 id="初构Android"><a href="#初构Android" class="headerlink" title="初构Android"></a>初构Android</h2><h3 id="文本绘制和基本交互"><a href="#文本绘制和基本交互" class="headerlink" title="文本绘制和基本交互"></a>文本绘制和基本交互</h3><h4 id="绘制的坑"><a href="#绘制的坑" class="headerlink" title="绘制的坑"></a>绘制的坑</h4><p>作为Android的重头戏，咱们必须了解的是文本绘制啊！<br>首先先来了解一下文本绘制中的巨坑。<br>以下是来自<code>BaseCanvas</code>(android.graphics)的一段关于drawText的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(<span class="meta">@NonNull</span> CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end, <span class="keyword">float</span> x, <span class="keyword">float</span> y,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@NonNull</span> Paint paint)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((start | end | (end - start) | (text.length() - end)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br><span class="line">    &#125;</span><br><span class="line">    throwIfHasHwBitmapInSwMode(paint);</span><br><span class="line">    <span class="keyword">if</span> (text <span class="keyword">instanceof</span> String || text <span class="keyword">instanceof</span> SpannedString ||</span><br><span class="line">            text <span class="keyword">instanceof</span> SpannableString) &#123;</span><br><span class="line">        nDrawText(mNativeCanvasWrapper, text.toString(), start, end, x, y,</span><br><span class="line">                paint.mBidiFlags, paint.getNativeInstance());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text <span class="keyword">instanceof</span> GraphicsOperations) &#123;</span><br><span class="line">        ((GraphicsOperations) text).drawText(<span class="keyword">this</span>, start, end, x, y,</span><br><span class="line">                paint);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">char</span>[] buf = TemporaryBuffer.obtain(end - start);</span><br><span class="line">        TextUtils.getChars(text, start, end, buf, <span class="number">0</span>);</span><br><span class="line">        nDrawText(mNativeCanvasWrapper, buf, <span class="number">0</span>, end - start, x, y,</span><br><span class="line">                paint.mBidiFlags, paint.getNativeInstance());</span><br><span class="line">        TemporaryBuffer.recycle(buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到第二个if里面的语句。我们发现，在传递文本给<code>nDrawText()</code>方法之前，<code>String</code>、<code>SpannedString</code>或者<code>SpannableString</code>都会被<code>toString()</code>一次！只要文本一长，在这个方法上牺牲的时间是很大的！<br>上一次写编辑框的时候就被这个<code>toString()</code>坑到了，在OPPO R7s上绘制几百行（只绘制可见区域，相当于有上百次的drawText()的提交），竟然到了1秒钟不能上24fps的地步（超过了绿线）。<br>我觉得不可能啊,于是又在Paint中发现了蹊跷:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">measureText</span><span class="params">(CharSequence text, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;text cannot be null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((start | end | (end - start) | (text.length() - end)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (text.length() == <span class="number">0</span> || start == end) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0f</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (text <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> measureText((String)text, start, end);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (text <span class="keyword">instanceof</span> SpannedString ||</span><br><span class="line">            text <span class="keyword">instanceof</span> SpannableString) &#123;</span><br><span class="line">            <span class="keyword">return</span> measureText(text.toString(), start, end);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (text <span class="keyword">instanceof</span> GraphicsOperations) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((GraphicsOperations)text).measureText(start, end, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>[] buf = TemporaryBuffer.obtain(end - start);</span><br><span class="line">        TextUtils.getChars(text, start, end, buf, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">float</span> result = measureText(buf, <span class="number">0</span>, end - start);</span><br><span class="line">        TemporaryBuffer.recycle(buf);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>原来Paint中也有如出一辙的操作!<br>再考虑到咱们自身绘制方法本来就有问题，提交次数太多了： 我们是一个一个字符绘制的。<br>每个字符都必须要<code>drawText()</code> + <code>measureText()</code>来实现OffsetX的转义。<br>节约的绘制远远比不上咱们一个字一个字提交绘制的时间，所以自然绘制就十分卡顿了。<br>emmmm…<br>这里必须提嘴一句的是,TextWarrior的绘制方式好像也是一个字一个字地绘制,不过他们用的不是直接提交<code>CharSequence</code>,而是提交一个长度为1或2的(为了支持Emoji时)<code>char[]</code>,避免了这一问题。但是绘制时间稍微有些长了。<br>扯完了上面这些，我们先来快速了解一下Android的文本绘制吧。<br>文本绘制的关键在于用上baseline（基线）。<br>baseline大抵相当于英文里面四线三格的第三条线，我们drawText要传入的就是这条线在画布上的位置。<br>baseline怎么获取呢？<br>下面这样就好了（其中mPaint是画笔对象，获取的值因Text Size而改变）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get line height</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> height of single line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLineHeight</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mPaint.getFontMetricsInt().descent - mPaint.getFontMetricsInt().ascent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get baseline directly</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> baseline y offset</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLineBaseLine</span><span class="params">(<span class="keyword">int</span> line)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getLineHeight() * (line + <span class="number">1</span>) - mPaint.getFontMetricsInt().descent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然,绘制的时候你还需要减去当前的X偏移量。<br>下面再给出获取其它几个量的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get line top y offset</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> top y offset</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLineTop</span><span class="params">(<span class="keyword">int</span> line)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getLineHeight() * line;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get line bottom y offset</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Bottom y offset</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLineBottom</span><span class="params">(<span class="keyword">int</span> line)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getLineHeight() * (line + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一个需要了解的是<code>Paint.Align</code><br>这有关我们传入给<code>drawText()</code>的X坐标。<br>有些人总以为这个X左边很简单，就是文本绘制的左边，事实上不是这样的。它因<code>Paint.Align</code>的变化而变化。<br><code>Paint.Align</code>是一个枚举类。<br>有：<code>LEFT</code>,<code>RIGHT</code>,<code>CENTER</code><br>都是什么意思呢?<br><code>LEFT</code>:传入的X坐标是文本绘制的左坐标<br><code>RIGHT</code>:传入的X坐标是文本绘制的右坐标<br><code>CENTER</code>:传入的X坐标是文本绘制的中心坐标(文本的横向中心X坐标为这个X值)</p>
<h4 id="绘制行号"><a href="#绘制行号" class="headerlink" title="绘制行号"></a>绘制行号</h4><p>绘制行号的时候,我们会用到它。<br>下面给出行号的绘制方法:<br>canvas:画布<br>offsetX:行号区域在画布上的起始坐标<br>width:最宽的行号的宽度,代表了行号区域的宽度<br>color:行号的颜色</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Draw line numbers on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> canvas Canvas to draw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offsetX Start region of line number region</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> width The width of line number region</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> color Color of line number</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawLineNumbers</span><span class="params">(Canvas canvas, <span class="keyword">float</span> offsetX, <span class="keyword">float</span> width, <span class="keyword">int</span> color)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(width + offsetX &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> first = getFirstVisibleLine();</span><br><span class="line">    <span class="keyword">int</span> last = getLastVisibleLine();</span><br><span class="line">    mPaint.setTextAlign(mLineNumberAlign);</span><br><span class="line">    mPaint.setColor(color);</span><br><span class="line">    mPaint.setTypeface(mTypefaceLineNumber);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = first;i &lt;= last;i++)&#123;</span><br><span class="line">        <span class="keyword">switch</span>(mLineNumberAlign)&#123;</span><br><span class="line">            <span class="keyword">case</span> LEFT:</span><br><span class="line">                canvas.drawText(Integer.toString(i + <span class="number">1</span>), offsetX, getLineBaseLine(i) - getOffsetY(), mPaint);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RIGHT:</span><br><span class="line">                canvas.drawText(Integer.toString(i + <span class="number">1</span>), offsetX + width, getLineBaseLine(i) - getOffsetY(), mPaint);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CENTER:</span><br><span class="line">                canvas.drawText(Integer.toString(i + <span class="number">1</span>), offsetX + width / <span class="number">2f</span>, getLineBaseLine(i) - getOffsetY(), mPaint);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mPaint.setTextAlign(Paint.Align.LEFT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="滚动操作"><a href="#滚动操作" class="headerlink" title="滚动操作"></a>滚动操作</h4><p>作为一个现实文本的工具,没有滚动怎么行?超出区域不就再也看不见了!<br>但是自己实现滚动,又必须考虑到用户的滚动手势!光拖拽怎么行?<br>没关系,Android已经给我们造好了轮子!<br>我们只需要使用<code>Scroller</code>(这里我们为了一些边缘效果,使用了<code>OverScroller</code>,两者皆在android.widget包下,没有继承关系,用法基本相同,<code>OverScroller</code>功能稍多)来执行滚动操作,<br>使用<code>GestureDetector</code>来实现手势的识别.<br>使用方法也很简单:<br>定义成员变量:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> GestureDetector mBasicDetector;</span><br></pre></td></tr></table></figure>
<p>在初始化咱们自己的View时:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mBasicDetector = <span class="keyword">new</span> GestureDetector(getContext(), mEventHandler);</span><br><span class="line">mBasicDetector.setOnDoubleTapListener(mEventHandler);</span><br></pre></td></tr></table></figure>
<p><code>EventHandler</code>需要实现:<code>GestureDetector.OnGestureListener</code>,<code>GestureDetector.OnDoubleTapListener</code><br>然后让它代替我们响应触摸事件:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressLint(&quot;ClickableViewAccessibility&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mBasicDetector.onTouchEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过这么做,<code>OnClickListener</code>会失效.<br>我们将会在EventHandler的<code>onSingleTapUpConfirmed(MotionEvent)</code>方法中得到单击的通知<br>** <code>onSingleTapUp()</code> 和 <code>onSingleTapUpConfirmed()</code> 的区别 ** :<br><code>onSingleTapUp()</code>仅仅是表达用户<strong>点击</strong>了我们的视图,但是不知道是不是连击<br>而<code>onSingleTapUpConfirmed()</code>表示用户确确实实<strong>单击</strong>了我们的视图,不存在连击<br>双击事件会在<code>onDoubleTap()</code>和<code>onDoubleTapEvent()</code>则是控制双击事件的,我们不做处理.<br>我们现在要做的,仅仅是滚动.<br>在EventHandler中写道:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onDown</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mEditor.isEnabled();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onScroll</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> distanceX, <span class="keyword">float</span> distanceY)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> endX = mScroller.getCurrX() + (<span class="keyword">int</span>)distanceX;</span><br><span class="line">    <span class="keyword">int</span> endY = mScroller.getCurrY() + (<span class="keyword">int</span>)distanceY;</span><br><span class="line">    endX = Math.max(endX,<span class="number">0</span>);</span><br><span class="line">    endY = Math.max(endY,<span class="number">0</span>);</span><br><span class="line">    endY = Math.min(endY,mEditor.getScrollMaxY());</span><br><span class="line">    endX = Math.min(endX,mEditor.getScrollMaxX());</span><br><span class="line">    mScroller.startScroll(mScroller.getCurrX(),</span><br><span class="line">            mScroller.getCurrY(),</span><br><span class="line">            endX - mScroller.getCurrX(),</span><br><span class="line">            endY - mScroller.getCurrY(),<span class="number">0</span>);</span><br><span class="line">    mEditor.invalidate();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onFling</span><span class="params">(MotionEvent e1, MotionEvent e2, <span class="keyword">float</span> velocityX, <span class="keyword">float</span> velocityY)</span> </span>&#123;</span><br><span class="line">    mScroller.fling(mScroller.getCurrX(),</span><br><span class="line">            mScroller.getCurrY(),</span><br><span class="line">            (<span class="keyword">int</span>)-velocityX,</span><br><span class="line">            (<span class="keyword">int</span>)-velocityY,</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mEditor.getScrollMaxX(),</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            mEditor.getScrollMaxY(),</span><br><span class="line">            <span class="number">20</span>,</span><br><span class="line">            <span class="number">20</span>);</span><br><span class="line">    mEditor.invalidate();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>mScroller</code>是我们<code>OverScroller</code>对象<br><code>mEditor</code>是我们的编辑框对象<br><code>getScrollMaxY()</code>和<code>getScrollMaxX()</code>定义在编辑框类中,<br><code>getScrollMaxY()</code>我们返回<code>getLineHeight() * getLineCount() - getHeight() / 2 </code>,让用户有额外半屏滑动,便于编辑<br><code>getScrollMaxX()</code>我们返回<code>mMaxPaintX - getWidth()/2</code>(<code>mMaxPaintX</code>:历史最大的绘制X)<br>上面通过Scroller实现的惯性滑动效果,必须在编辑框类中做一点小处理才行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeScroll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(mEventHandler.getScroller().computeScrollOffset())&#123;</span><br><span class="line">        invalidate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.computeScroll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不加上面的代码,那么惯性滑动就不会看到了(除非我们再一次<code>invalidate()</code>).<br>因为我们没有持续绘制.<br><code>computeScroll()</code>会在绘制阶段被调用,我们得以持续绘制动画.</p>
<h4 id="初步绘制文本"><a href="#初步绘制文本" class="headerlink" title="初步绘制文本"></a>初步绘制文本</h4><p>终于到了绘制文本的阶段了,我们调试编辑框,最先就是得把文本画出来啊!要不然,怎么看得到效果呢?<br>由于是初步绘制用于调试,我们先不实现高亮,只实现绘制.<br>但是,为了性能考虑,我们应该只绘制可见部分的行才对:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get first visible line on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> first visible line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getFirstVisibleLine</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j = Math.min(getOffsetY() / getLineHeight(), getLineCount() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(j &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> j;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get last visible line on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> last visible line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLastVisibleLine</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> l = Math.min((getOffsetY() + getHeight()) / getLineHeight(), getLineCount() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(l &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是简单绘制文本的方法:<br>为了防止一些坑,我们定义成员变量<code>mChars</code>临时保存正在绘制的行的具体内容,绘制这一行之前,我们调用<code>prepareLine(int)</code>来填充这一行的内容到<code>mChars</code><br>然后,我们调用我们自己定义的drawText方法绘制,以便显示出Tab.最后,用我们自己的方法测量出这一行的宽带,尝试更新最大的滚动X值<br>canvas:画布<br>offsetX:在屏幕上的起始位置<br>color:文字颜色<br>startLine:第一个要绘制的行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Draw text without any spans</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> canvas Canvas to draw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offsetX Start x of text region</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> color Color to draw text</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> startLine The start line to paint</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTextDirect</span><span class="params">(Canvas canvas, <span class="keyword">float</span> offsetX, <span class="keyword">int</span> color, <span class="keyword">int</span> startLine)</span></span>&#123;</span><br><span class="line">    mPaint.setColor(color);</span><br><span class="line">    mPaint.setTypeface(mTypefaceText);</span><br><span class="line">    <span class="keyword">int</span> last = getLastVisibleLine();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = startLine;i &lt;= last;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(mText.getColumnCount(i) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        prepareLine(i);</span><br><span class="line">        drawText(canvas, mChars, <span class="number">0</span>, mText.getColumnCount(i), offsetX, getLineBaseLine(i) - getOffsetY());</span><br><span class="line">        <span class="keyword">float</span> width = measureText(mChars,<span class="number">0</span>,mText.getColumnCount(i)) + offsetX;</span><br><span class="line">        <span class="keyword">if</span>(width &gt; mMaxPaintX) &#123;</span><br><span class="line">            mMaxPaintX = width;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read characters to mChars for the given line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line going to draw or measure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareLine</span><span class="params">(<span class="keyword">int</span> line)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> length = mText.getColumnCount(line);</span><br><span class="line">    <span class="keyword">if</span>(length &gt;= mChars.length)&#123;</span><br><span class="line">        mChars = <span class="keyword">new</span> <span class="keyword">char</span>[length + <span class="number">100</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; length;i++)&#123;</span><br><span class="line">        mChars[i] = mText.charAt(line, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Draw text on the given position</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> canvas Canvas to draw</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> src Source of characters</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index The index in array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count Count of characters</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offX Offset x for paint</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offY Offset y for paint(baseline)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(Canvas canvas, <span class="keyword">char</span>[] src, <span class="keyword">int</span> index, <span class="keyword">int</span> count, <span class="keyword">float</span> offX, <span class="keyword">float</span> offY)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> end = index + count;</span><br><span class="line">    <span class="keyword">int</span> st = index;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = index;i &lt; end;i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(src[i] == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            canvas.drawText(src,st,i - st,offX,offY,mPaint);</span><br><span class="line">            offX = offX + measureText(src,st,i - st + <span class="number">1</span>);</span><br><span class="line">            st = i + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(st &lt; end) &#123;</span><br><span class="line">        canvas.drawText(src,st,end - st,offX,offY,mPaint);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Measure text width</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> src Source characters array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index Start index in array</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> count Count of characters</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> The width measured</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">float</span> <span class="title">measureText</span><span class="params">(<span class="keyword">char</span>[] src, <span class="keyword">int</span> index, <span class="keyword">int</span> count)</span></span>&#123;</span><br><span class="line">    mPaint.setTypeface(mTypefaceText);</span><br><span class="line">    <span class="keyword">float</span> extraWidth;</span><br><span class="line">    <span class="keyword">int</span> tabCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; count;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(src[index + i] == <span class="string">&#x27;\t&#x27;</span>)&#123;</span><br><span class="line">            tabCount++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span> &amp;&amp; isEmoji(src[index + count - <span class="number">1</span>])) &#123;</span><br><span class="line">        count--;</span><br><span class="line">        <span class="keyword">if</span>(count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    extraWidth = mSpaceWidth * (getTabWidth() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> mPaint.measureText(src, index, count) + tabCount * extraWidth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Check whether the given character is a start sign for emoji</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ch Character to check</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Whether this is leading a emoji</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEmoji</span><span class="params">(<span class="keyword">char</span> ch)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ch == <span class="number">0xd83c</span> || ch == <span class="number">0xd83d</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此,一个能显示文本和行号外加分割线的编辑框的绘制部分就基本完成了!<br>下面我们来控制输入:</p>
<h4 id="实现输入和删除"><a href="#实现输入和删除" class="headerlink" title="实现输入和删除"></a>实现输入和删除</h4><p>首先必须让别人知道我们是个输入框才行:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCheckIsTextEditor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> isEnabled() &amp;&amp; isEditable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让后创建我们自己的InputConnection类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> InputConnection <span class="title">onCreateInputConnection</span><span class="params">(EditorInfo outAttrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!isEditable() || !isEnabled())&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    outAttrs.inputType = EditorInfo.TYPE_TEXT_FLAG_MULTI_LINE;</span><br><span class="line">    mConnection.reset();</span><br><span class="line">    <span class="keyword">return</span> mConnection;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了方便,我们自己的Connection只创建一次,后面直接重置.根据测试,如果总是返回创建的新对象,后面我们发现这回导致第一次启动输入的时候无法获取到ComposingText的位置(在我们的Connection保存和自动修改的)<br>后面直接<code>reset()</code>重置状态即可.<br>其中<code>setComposingText()</code>就是我们为了实现ComposingText位置获取的逻辑了.ComposingText中不存在回车/换行.<br>Cursor是游标,可进仓库查看具体实现.Left指左游标,Right指右游标,<code>set()</code>设置两个游标.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RoseEditorInputConnection</span> <span class="keyword">extends</span> <span class="title">BaseInputConnection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RoseEditor mEditor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> actionCode = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> length = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> StringBuilder commit = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> composingLine = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> composingStart = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> composingEnd = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a connection for the given editor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetView Host editor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RoseEditorInputConnection</span><span class="params">(RoseEditor targetView)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(targetView, <span class="keyword">true</span>);</span><br><span class="line">        mEditor = targetView;</span><br><span class="line">        finishComposingText();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reset the state of this connection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>&#123;</span><br><span class="line">        commit = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        composingEnd = composingStart = composingLine = -<span class="number">1</span>;</span><br><span class="line">        actionCode = -<span class="number">1</span>;</span><br><span class="line">        length = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Private use.</span></span><br><span class="line"><span class="comment">     * Get the Cursor of Content displaying by Editor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Cursor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Cursor <span class="title">getCursor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mEditor.getCursor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.closeConnection();</span><br><span class="line">        mEditor.onCloseConnection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">commitText</span><span class="params">(CharSequence text, <span class="keyword">int</span> newCursorPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(text == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(mEditor.isEditable())&#123;</span><br><span class="line">            <span class="keyword">if</span>(composingLine != -<span class="number">1</span>)&#123;</span><br><span class="line">                commit.append(text);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            getCursor().onCommitText(text);</span><br><span class="line">            actionCode = <span class="number">0</span>;</span><br><span class="line">            length = text.length();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mEditor.isEditable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteSurroundingText</span><span class="params">(<span class="keyword">int</span> beforeLength, <span class="keyword">int</span> afterLength)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(mEditor.isEditable())&#123;</span><br><span class="line">            getCursor().onDeleteKeyPressed();</span><br><span class="line">            actionCode = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mEditor.isEditable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">beginBatchEdit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mEditor.getText().beginBatchEdit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">endBatchEdit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mEditor.getText().endBatchEdit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setComposingText</span><span class="params">(CharSequence text, <span class="keyword">int</span> newCursorPosition)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!mEditor.isEditable())&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(text == <span class="keyword">null</span>)&#123;</span><br><span class="line">            finishComposingText();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(composingLine == -<span class="number">1</span>)&#123;</span><br><span class="line">            commit = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">if</span>(getCursor().isSelected())</span><br><span class="line">                getCursor().onDeleteKeyPressed();</span><br><span class="line">            composingLine = mEditor.getCursor().getRightLine();</span><br><span class="line">            composingStart = mEditor.getCursor().getRightColumn();</span><br><span class="line">            composingEnd = composingStart + text.length();</span><br><span class="line">            getCursor().onCommitText(text);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            getCursor().setLeft(composingLine,composingStart);</span><br><span class="line">            getCursor().setRight(composingLine,composingEnd);</span><br><span class="line">            composingEnd = composingStart + text.length();</span><br><span class="line">            getCursor().onCommitText(text);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">finishComposingText</span><span class="params">()</span></span>&#123;</span><br><span class="line">        composingStart = -<span class="number">1</span>;</span><br><span class="line">        composingEnd = -<span class="number">1</span>;</span><br><span class="line">        composingLine = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span>(commit.length() != <span class="number">0</span>)&#123;</span><br><span class="line">            getCursor().onCommitText(commit);</span><br><span class="line">            commit = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setSelection</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(actionCode == <span class="number">0</span> &amp;&amp; length == <span class="number">2</span>)&#123;</span><br><span class="line">            Cursor cur = getCursor();</span><br><span class="line">            cur.setLeft(cur.getLeftLine(),cur.getLeftColumn() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们发现,回车迟迟输入不了,这是为什么呢?<br>我们覆盖<code>InputConnection#sendKeyEvent()</code>,弹出Toast发现:回车和删除通过KeyEvent发送.<br>注意到<code>BaseInputConnection</code>已经实现了KeyEvent派遣到我们View的逻辑,只需要在我们的View里面重写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onKeyDown</span><span class="params">(<span class="keyword">int</span> keyCode, KeyEvent event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(event.getAction() == KeyEvent.ACTION_DOWN)&#123;</span><br><span class="line">        <span class="keyword">switch</span>(keyCode)&#123;</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_DEL:</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_FORWARD_DEL:</span><br><span class="line">                <span class="keyword">return</span> mConnection.deleteSurroundingText(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">case</span> KeyEvent.KEYCODE_ENTER:</span><br><span class="line">                <span class="keyword">return</span> mConnection.commitText(<span class="string">&quot;\n&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onKeyDown(keyCode, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样,编辑功能就OK了.</p>
<h4 id="设定游标"><a href="#设定游标" class="headerlink" title="设定游标"></a>设定游标</h4><p>输入必须得涉及到游标.<br>如何判断手指下的游标位置呢?只要简单measure一下就行了!<br>先写EventHandler:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSingleTapConfirmed</span><span class="params">(MotionEvent e)</span> </span>&#123;</span><br><span class="line">    mEditor.showSoftInput();</span><br><span class="line">    mScroller.forceFinished(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">int</span> line = mEditor.getPointLineOnScreen(e.getY());</span><br><span class="line">    <span class="keyword">int</span> column = mEditor.getPointColumnOnScreen(line,e.getX());</span><br><span class="line">    mEditor.setSelection(line,column);</span><br><span class="line">    mEditor.hideAutoCompletePanel();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是在View中实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get y position in scroll bounds&#x27;s line&#x27;s line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> yPos Y in scroll bounds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPointLine</span><span class="params">(<span class="keyword">float</span> yPos)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r = (<span class="keyword">int</span>)yPos / getLineHeight();</span><br><span class="line">    <span class="keyword">return</span> r &lt; <span class="number">0</span> ? <span class="number">0</span> : r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get Y position on screen&#x27;s line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> y Y on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPointLineOnScreen</span><span class="params">(<span class="keyword">float</span> y)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Math.min(getPointLine(y + getOffsetY()),getLineCount() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get column in line for offset x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x Offset x</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Column in line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPointColumn</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">float</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(line &gt;= getLineCount()) &#123;</span><br><span class="line">        line = getLineCount() - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">float</span> w = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    prepareLine(line);</span><br><span class="line">    <span class="keyword">while</span>(w &lt; x &amp;&amp; i &lt; mText.getColumnCount(line))&#123;</span><br><span class="line">        w += measureText(mChars, i, <span class="number">1</span>);</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(w &lt; x)&#123;</span><br><span class="line">        i = mText.getColumnCount(line);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get column for x offset on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> line Line</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> x X offset on screen</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> Column in line</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPointColumnOnScreen</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">float</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">float</span> xx = x + getOffsetX() - mDividerMargin * <span class="number">2</span> - mDividerWidth - measureLineNumber();</span><br><span class="line">    <span class="keyword">return</span> getPointColumn(line, xx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>至此,编辑框的基础功能已经好了,高亮功能稍后在做.由于10-11月的CSP非专业级考试就要来了,所以暂时停止更新.</p>
<h3 id="高亮文本"><a href="#高亮文本" class="headerlink" title="高亮文本"></a>高亮文本</h3><p>从CSP差一分得省一的我回来了,依旧没有认真学习算法和数据结构的念头,反倒是继续更新编辑框了.</p>
<h4 id="绘制Spans"><a href="#绘制Spans" class="headerlink" title="绘制Spans"></a>绘制Spans</h4><p>我们把Span定义成一个只有开始位置和颜色的标记,List中下一个Span的开始位置,就是现在这个Span的结束位置,并且最后一个Span的结束位置是文末.<br>这样,就可以保证整篇文章都是被Span覆盖,可以方便地寻找位置.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Span</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> startIndex,line,column;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> colorId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a span with brief position</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> i Index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> l Line</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c Column</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cid Color ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Span</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> l, <span class="keyword">int</span> c, <span class="keyword">int</span> cid)</span></span>&#123;</span><br><span class="line">        colorId = cid;</span><br><span class="line">        startIndex = i;</span><br><span class="line">        line = l;</span><br><span class="line">        column = c;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Make self zero</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> self</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Span <span class="title">wrap</span><span class="params">()</span></span>&#123;</span><br><span class="line">        line = column = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Calculate line and column</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c Target content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> self</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Span <span class="title">wrap</span><span class="params">(Content c)</span></span>&#123;</span><br><span class="line">        CharPosition pos = c.getIndexer().getCharPosition(startIndex);</span><br><span class="line">        line = pos.line;</span><br><span class="line">        column = pos.column;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new span from the given start index and color ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start The start index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> colorId Type of span</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Span</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> colorId)</span></span>&#123;</span><br><span class="line">        startIndex = start;</span><br><span class="line">        <span class="keyword">this</span>.colorId = colorId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get span start line</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Start line</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLine</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> line;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get span start column</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Start column</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColumn</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> column;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后开始绘制!首先,由于我们是按行绘制,所以我们需要找到每一行行首对应需要绘制的Span,我们定义<code>seekTo()</code>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">seekTo</span><span class="params">(List&lt;Span&gt; spans, <span class="keyword">int</span> line,<span class="keyword">int</span> curr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(curr &lt; spans.size()) &#123;</span><br><span class="line">        Span span = spans.get(curr);</span><br><span class="line">        <span class="keyword">if</span>(span.getLine() &lt; line &amp;&amp; curr + <span class="number">1</span> &lt; spans.size() &amp;&amp; (spans.get(curr + <span class="number">1</span>).getLine() &lt; line||(spans.get(curr + <span class="number">1</span>).getLine() == line &amp;&amp; spans.get(curr + <span class="number">1</span>).getColumn() == <span class="number">0</span>)))&#123;</span><br><span class="line">            curr++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> curr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们就可以绘制了:<br>我们的策略是按Span绘制一系列文本,而不是一个一个字符绘制,每绘制完一行,就重新开始绘制下一行.<br>不可见的区域不会被绘制.<br>IndexOutOfBoundsException的出现是因为改变了文本内容,相应的位置发生了变化,所以超出了范围,这时我们调用前面编写的<code>drawTextDirect()</code>方法绘制,来弥补这一错误,并且停止通过本方法绘制.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawTextBySpans</span><span class="params">(Canvas canvas, <span class="keyword">float</span> offsetX, TextColorProvider.TextColors colors)</span></span>&#123;</span><br><span class="line">    mPaint.setTypeface(mTypefaceText);</span><br><span class="line">    ColorScheme cs = mColors;</span><br><span class="line">    List&lt;Span&gt; spans = colors.getSpans();</span><br><span class="line">    <span class="keyword">int</span> first = getFirstVisibleLine();</span><br><span class="line">    <span class="keyword">int</span> last = getLastVisibleLine();</span><br><span class="line">    <span class="keyword">int</span> index = <span class="number">0</span>,copy;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = first;i &lt;= last;i++)&#123;</span><br><span class="line">        index = seekTo(spans, i, index);</span><br><span class="line">        copy = index;</span><br><span class="line">        <span class="keyword">float</span> off = offsetX;</span><br><span class="line">        prepareLine(i);</span><br><span class="line">        <span class="keyword">float</span> y = getLineBaseLine(i) - getOffsetY();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">                Span span = spans.get(copy),next = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span>(copy + <span class="number">1</span> &lt; spans.size())&#123;</span><br><span class="line">                    next = spans.get(copy + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> st = span.getLine() == i ? span.getColumn() : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> ed = next == <span class="keyword">null</span> ? mText.getColumnCount(i) : (next.getLine() == i ? next.getColumn() : mText.getColumnCount(i));</span><br><span class="line">                <span class="keyword">float</span> width = measureText(mChars, st, ed - st);</span><br><span class="line">                <span class="keyword">if</span>(off + width &gt; <span class="number">0</span> &amp;&amp; off &lt; getWidth()) &#123;</span><br><span class="line">                    mPaint.setColor(cs.getColor(span.colorId));</span><br><span class="line">                    drawText(canvas, mChars, st, ed - st, off, y);</span><br><span class="line">                &#125;</span><br><span class="line">                off += width;</span><br><span class="line">                <span class="keyword">if</span>(off - offsetX &gt; mMaxPaintX)&#123;</span><br><span class="line">                    mMaxPaintX = off - offsetX;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(next == <span class="keyword">null</span> || next.getLine() != i)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                copy++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span>(IndexOutOfBoundsException e)&#123;</span><br><span class="line">            drawTextDirect(canvas, offsetX, mColors.getColor(ColorScheme.TEXT_NORMAL), i);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们再写一个类用于绘制测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestA</span> <span class="keyword">implements</span> <span class="title">Analyzer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">(Content content, TextColorProvider.TextColors colors, TextColorProvider.AnalyzeThread.Delegate delegate)</span> </span>&#123;</span><br><span class="line">        colors.addIfNeeded(<span class="number">0</span>, ColorScheme.CURRENT_LINE,content);</span><br><span class="line">        colors.addIfNeeded(<span class="number">3</span>,ColorScheme.SELECTION_HANDLE,content);</span><br><span class="line">        colors.addIfNeeded(<span class="number">10</span>,ColorScheme.LINE_DIVIDER,content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试通过.<br>然后,本项目再一次被抛弃了一个月(2019/12~2020/01期间)</p>
<h2 id="词法分析器"><a href="#词法分析器" class="headerlink" title="词法分析器"></a>词法分析器</h2><p>本来我是不打算继续更新编辑器了的,因为想到高亮代码的分析就觉得麻烦,烦躁.<br>不过,可喜的是寒假再一次地来到了.每当这个时候Rose总是要写一些好东西出来,今年也一样.<br>虽然今年寒假开头就给我补了5天课让我很不爽,不过幸好补课不用上晚自习.于是在晚上我就上网扯淡了.<br>想到暑假为新生的S5droid写了不少东西,也晓得了JFLex这个东西,我想了一下:每一次更新关键字都必须要改flex重新生成,真鸡儿麻烦,反正闲着也是没事干,我为什么不尝试手写一个词法分析器看看?<br>于是,词法分析器就开坑了.</p>
<h3 id="定义单词"><a href="#定义单词" class="headerlink" title="定义单词"></a>定义单词</h3><p>我们定义枚举类型<code>Tokens</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Tokens</span> </span>&#123;</span><br><span class="line">    <span class="comment">//空白符号类 Whitespaces</span></span><br><span class="line">    WHITESPACE,</span><br><span class="line">    NEWLINE,</span><br><span class="line">    UNKNOWN,</span><br><span class="line">    EOF,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注释类 Comments</span></span><br><span class="line">    LONG_COMMENT,<span class="comment">//长注释 Long comment</span></span><br><span class="line">    LINE_COMMENT,<span class="comment">//单行注释 Single line comment</span></span><br><span class="line"></span><br><span class="line">    DIV,<span class="comment">//除</span></span><br><span class="line">    MULT,<span class="comment">//乘</span></span><br><span class="line">    IDENTIFIER,<span class="comment">//标识符</span></span><br><span class="line">    INTEGER_LITERAL,<span class="comment">//整数</span></span><br><span class="line">    DOT,<span class="comment">//点</span></span><br><span class="line">    MINUS,<span class="comment">//减</span></span><br><span class="line">    STRING,<span class="comment">//字符串</span></span><br><span class="line">    CHARACTER_LITERAL,<span class="comment">//字符</span></span><br><span class="line">    LPAREN,<span class="comment">//左小括号</span></span><br><span class="line">    RPAREN,<span class="comment">//右小括号</span></span><br><span class="line">    LBRACE,<span class="comment">//左大括号</span></span><br><span class="line">    RBRACE,<span class="comment">//右大括号</span></span><br><span class="line">    LBRACK,<span class="comment">//左中括号</span></span><br><span class="line">    RBRACK,<span class="comment">//右中括号</span></span><br><span class="line">    SEMICOLON,<span class="comment">//分号</span></span><br><span class="line">    COMMA,<span class="comment">//逗号</span></span><br><span class="line">    EQ,<span class="comment">//等于</span></span><br><span class="line">    GT,<span class="comment">//大于</span></span><br><span class="line">    LT,<span class="comment">//小于</span></span><br><span class="line">    NOT,<span class="comment">//非</span></span><br><span class="line">    COMP,<span class="comment">//~</span></span><br><span class="line">    QUESTION,<span class="comment">//问号</span></span><br><span class="line">    COLON,<span class="comment">//冒号</span></span><br><span class="line">    AND,<span class="comment">//与</span></span><br><span class="line">    OR,<span class="comment">//或</span></span><br><span class="line">    PLUS,<span class="comment">//加</span></span><br><span class="line">    XOR,<span class="comment">//异或</span></span><br><span class="line">    MOD,<span class="comment">//百分号</span></span><br><span class="line">    DIVEQ,</span><br><span class="line">    MULTEQ,</span><br><span class="line">    FLOATING_POINT_LITERAL,<span class="comment">//浮点数</span></span><br><span class="line">    MINUSMINUS,<span class="comment">//减减</span></span><br><span class="line">    MINUSEQ,</span><br><span class="line">    EQEQ,<span class="comment">//等于等于</span></span><br><span class="line">    GTEQ,</span><br><span class="line">    RSHIFT,<span class="comment">//右位移</span></span><br><span class="line">    LTEQ,</span><br><span class="line">    LSHIFT,<span class="comment">//左位移</span></span><br><span class="line">    NOTEQ,</span><br><span class="line">    ANDEQ,</span><br><span class="line">    ANDAND,<span class="comment">//与与</span></span><br><span class="line">    OREQ,</span><br><span class="line">    OROR,<span class="comment">//或或</span></span><br><span class="line">    PLUSEQ,</span><br><span class="line">    PLUSPLUS,<span class="comment">//加加</span></span><br><span class="line">    XOREQ,</span><br><span class="line">    MODEQ,</span><br><span class="line">    RSHIFTEQ,</span><br><span class="line">    URSHIFT,</span><br><span class="line">    LSHIFTEQ,</span><br><span class="line">    URSHIFTEQ,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关键字</span></span><br><span class="line">    FORLOOP,<span class="comment">//变量循环</span></span><br><span class="line">    WHILELOOP,<span class="comment">//判断循环</span></span><br><span class="line">    LONGV,<span class="comment">//长整数型</span></span><br><span class="line">    DOUBLEV,<span class="comment">//双精度型</span></span><br><span class="line">    FLOATV,<span class="comment">//浮点数型</span></span><br><span class="line">    BOOLEANV,<span class="comment">//逻辑型</span></span><br><span class="line">    INTV,<span class="comment">//整数型</span></span><br><span class="line">    STRINGV,<span class="comment">//文本型</span></span><br><span class="line">    OBJECT,<span class="comment">//对象</span></span><br><span class="line">    VARIANT,<span class="comment">//变量</span></span><br><span class="line">    ELSE,<span class="comment">//否则</span></span><br><span class="line">    IF,<span class="comment">//如果</span></span><br><span class="line">    STATIC,<span class="comment">//静态</span></span><br><span class="line">    CASE,<span class="comment">//分支</span></span><br><span class="line">    SWITCH,<span class="comment">//判断</span></span><br><span class="line">    LOOP,<span class="comment">//循环</span></span><br><span class="line">    METHOD,<span class="comment">//方法</span></span><br><span class="line">    EVENT,<span class="comment">//事件</span></span><br><span class="line">    END,<span class="comment">//结束</span></span><br><span class="line">    RETURN,<span class="comment">//返回</span></span><br><span class="line">    NEW,<span class="comment">//创建</span></span><br><span class="line">    NULL,<span class="comment">//空</span></span><br><span class="line">    FALSE,<span class="comment">//假</span></span><br><span class="line">    TRUE,<span class="comment">//真</span></span><br><span class="line">    TO,<span class="comment">//至</span></span><br><span class="line">    THEN,<span class="comment">//则</span></span><br><span class="line">    AS,<span class="comment">//为</span></span><br><span class="line">    ANDK,<span class="comment">//与</span></span><br><span class="line">    ORK,<span class="comment">//或</span></span><br><span class="line">    ELSEIF,<span class="comment">//否则如果</span></span><br><span class="line">    FORWARD,<span class="comment">//步进</span></span><br><span class="line">    BACK,<span class="comment">//步退</span></span><br><span class="line">    TRY,<span class="comment">//容错处理</span></span><br><span class="line">    CATCH,<span class="comment">//捕获</span></span><br><span class="line">    SIMPLE_TRY,<span class="comment">//容错</span></span><br><span class="line">    THIS,<span class="comment">//本对象</span></span><br><span class="line">    ASSERT,<span class="comment">//断言</span></span><br><span class="line">    BREAK,<span class="comment">//跳出</span></span><br><span class="line">    CONTINUE,<span class="comment">//跳过</span></span><br><span class="line">    INSTANCEOF,<span class="comment">//从属于</span></span><br><span class="line">    CHARV,<span class="comment">//字节型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>别吐槽字节型为什么是CHARV,不是我命的名啊…<br>到今天它已经多了两个新成员:类/继承,这里没加(懒)</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>单词的构成都是有约束条件的.我们可以稍加分析:<br>空白符：诸如Tab、空格、垂直制表符<br>换行：\r\n或\n或\r<br>长度不为1的运算符:只需要向后逐字判断即可<br>数字:包括基本的十进制,以0打头的8进制,以0x或0X打头的16进制<br>字符常量:以’开头,以’结束,中间可以是一个字符或者一个转义的字符(\u….)<br>字符串常量:可以包括很多字符/转义字符<br>标识符:第一个字符属于IdentifierStart,后面部分属于IdentifierPart<br>关键字:和标识符具有相同的特征,本质是一个标识符,所以我们可以在扫描出一个标识符的时候测试它是否是一个关键字</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><p>只需要一堆switch和if就可以实现了.为了方便,我们直接采用<code>CharSequence</code>作为操作对象,而不使用<code>Reader</code>了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">public</span> Tokens <span class="title">nextToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       Tokens token;</span><br><span class="line">       <span class="keyword">do</span> &#123;</span><br><span class="line">           token = directNextToken();</span><br><span class="line">       &#125; <span class="keyword">while</span> ((skipWS &amp;&amp; token == WHITESPACE) || (skipComment &amp;&amp; (token == LINE_COMMENT || token == LONG_COMMENT)));</span><br><span class="line">       currToken = token;</span><br><span class="line">       <span class="keyword">return</span> token;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Tokens <span class="title">directNextToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (lcCal) &#123;</span><br><span class="line">           <span class="keyword">boolean</span> r = <span class="keyword">false</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = offset; i &lt; offset + length; i++) &#123;</span><br><span class="line">               <span class="keyword">char</span> ch = charAt(i);</span><br><span class="line">               <span class="keyword">if</span> (ch == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">                   r = <span class="keyword">true</span>;</span><br><span class="line">                   line++;</span><br><span class="line">                   column = <span class="number">0</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (r) &#123;</span><br><span class="line">                       r = <span class="keyword">false</span>;</span><br><span class="line">                       <span class="keyword">continue</span>;</span><br><span class="line">                   &#125;</span><br><span class="line">                   line++;</span><br><span class="line">                   column = <span class="number">0</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   r = <span class="keyword">false</span>;</span><br><span class="line">                   column++;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       index = index + length;</span><br><span class="line">       offset = offset + length;</span><br><span class="line">       <span class="keyword">if</span> (offset == bufferLen) &#123;</span><br><span class="line">           <span class="keyword">return</span> EOF;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">char</span> ch = source.charAt(offset);</span><br><span class="line">       length = <span class="number">1</span>;</span><br><span class="line">       <span class="keyword">if</span> (ch == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> NEWLINE;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">&#x27;\r&#x27;</span>) &#123;</span><br><span class="line">           scanNewline();</span><br><span class="line">           <span class="keyword">return</span> NEWLINE;</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isWhitespace(ch)) &#123;</span><br><span class="line">           <span class="keyword">char</span> chLocal;</span><br><span class="line">           <span class="keyword">while</span> (offset + length &lt; bufferLen &amp;&amp; isWhitespace(chLocal = charAt(offset + length)) ) &#123;</span><br><span class="line">               <span class="keyword">if</span> (chLocal == <span class="string">&#x27;\r&#x27;</span> || chLocal == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               length++;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> WHITESPACE;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (isIdentifierStart(ch)) &#123;</span><br><span class="line">               <span class="keyword">return</span> scanIdentifier(ch);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">if</span> (isPrimeDigit(ch)) &#123;</span><br><span class="line">               <span class="keyword">return</span> scanNumber();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/* Scan usual symbols first */</span></span><br><span class="line">           <span class="keyword">if</span>(ch == <span class="string">&#x27;;&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> SEMICOLON;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ch == <span class="string">&#x27;(&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> LPAREN;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ch == <span class="string">&#x27;)&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> RPAREN;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ch == <span class="string">&#x27;:&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> COLON;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ch == <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> scanLT();</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(ch == <span class="string">&#x27;&gt;&#x27;</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span> scanGT();</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">/* Scan secondly symbols */</span></span><br><span class="line">           <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;=&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, EQ, EQEQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;.&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> DOT;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> LBRACE;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> RBRACE;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanDIV();</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, MULT, MULTEQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, MINUS, MINUSEQ, MINUSMINUS);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;+&#x27;</span>, PLUS, PLUSEQ, PLUSPLUS);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> LBRACK;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;]&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> RBRACK;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;,&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> COMMA;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;!&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> NOT;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;~&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> COMP;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> QUESTION;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;&amp;&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;&amp;&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, AND, ANDAND, ANDEQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;|&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;|&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, OR, OROR, OREQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;^&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, XOR, XOREQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">                   <span class="keyword">return</span> scanOperatorTwo(<span class="string">&#x27;=&#x27;</span>, MOD, MODEQ);</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;\&#x27;&#x27;</span>:</span><br><span class="line">                   scanCharLiteral();</span><br><span class="line">                   <span class="keyword">return</span> CHARACTER_LITERAL;</span><br><span class="line">               <span class="keyword">case</span> <span class="string">&#x27;\&quot;&#x27;</span>:</span><br><span class="line">                   scanStringLiteral();</span><br><span class="line">                   <span class="keyword">return</span> STRING;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                   error(<span class="string">&quot;没有匹配的Token : &#x27;&quot;</span> + ch + <span class="string">&quot; &#x27;&quot;</span>, <span class="keyword">new</span> StringAdvice(<span class="string">&quot;检查是否使用了非法的符号，比如误使用了中文符号代替英文符号等&quot;</span>));</span><br><span class="line">                   <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> Tokens <span class="title">scanOperatorTwo</span><span class="params">(<span class="keyword">char</span> ex1, <span class="keyword">char</span> ex2, Tokens ifWrong, Tokens ifRight1, Tokens ifRight2)</span></span>;</span><br><span class="line">   <span class="function"><span class="keyword">protected</span> Tokens <span class="title">scanOperatorTwo</span><span class="params">(<span class="keyword">char</span> expected, Tokens ifWrong, Tokens ifRight)</span></span>;</span><br></pre></td></tr></table></figure>
<p>二级方法略,其中<code>isIdentifierStart()</code>和<code>isIdentifierPart()</code>直接调用<code>Character</code>的<code>isJavaIdentifierStart()</code>和<code>isJavaIdentifierPart()</code>方法<br>至于关键字,我们只需要用一个<code>HashMap&lt;String,Tokens&gt;</code>就可以实现操作了.<br>成功识别出词法.</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>在上面的过程后,我们虽然分析出了词法,可是和JFLex比起来却慢得多,这令人疑惑不解.<br>我们注意到了这个方法的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTokenString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> source.subSequence(offset, offset + length).toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次我们识别标识符的时候都必须利用这个方法得到Token的内容,只这一下调用,我们就必须创建2个新对象!<br>而我们写程序的时候,往往标识符是很多的,所以我们自然就慢了!<br>我们希望有一个方法,不需要创建对象,就可以识别出它是不是个标识符,而复杂度和<code>HashMap</code>一样!<br>这个时候,我们想起了<code>TrieTree</code>.<br><code>TrieTree</code>实际上就是一颗树,它的每个字符都是一个节点,节点依据输入字符串的顺序连接,最终节点标记为tail.<br>如果我们hash一下的话,那么获取相应叶节点的复杂度均摊是O(1),我们一般需要操作n次,所以折合应该是O(n),而且因为关键字很稀少,我们往往查找到一半甚至还在根节点就无结果返回了,这又节约了不少时间.<br>这样一来n的系数又变小了,所以效率很高.<br>我们于是写出了<code>TrieTree</code>的实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrieTree</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Node&lt;T&gt; root;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxLen;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrieTree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        root = <span class="keyword">new</span> Node&lt;&gt;();</span><br><span class="line">        maxLen = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String v,T token)</span> </span>&#123;</span><br><span class="line">        maxLen = Math.max(v.length(),maxLen);</span><br><span class="line">        addInternal(root,v,<span class="number">0</span>,v.length(),token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(CharSequence v,<span class="keyword">int</span> off,<span class="keyword">int</span> len,T token)</span> </span>&#123;</span><br><span class="line">        maxLen = Math.max(maxLen,len);</span><br><span class="line">        addInternal(root,v,off,len,token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">(CharSequence s,<span class="keyword">int</span> offset,<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(len &gt; maxLen) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInternal(root,s,offset,len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> T <span class="title">getInternal</span><span class="params">(Node&lt;T&gt; node,CharSequence s,<span class="keyword">int</span> offset,<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> node.token;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">char</span> point = s.charAt(offset);</span><br><span class="line">        Node&lt;T&gt; sub = node.map.get(point);</span><br><span class="line">        <span class="keyword">if</span>(sub == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getInternal(sub, s, offset + <span class="number">1</span>, len - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addInternal</span><span class="params">(Node&lt;T&gt; node,CharSequence v,<span class="keyword">int</span> i,<span class="keyword">int</span> len,T token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> point = v.charAt(i);</span><br><span class="line">        Node&lt;T&gt; sub = node.map.get(point);</span><br><span class="line">        <span class="keyword">if</span>(sub == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sub = <span class="keyword">new</span> Node&lt;&gt;();</span><br><span class="line">            node.map.put(point, sub);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(len == <span class="number">1</span>) &#123;</span><br><span class="line">            sub.token = token;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            addInternal(sub, v, i + <span class="number">1</span>,len - <span class="number">1</span>, token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> HashCharMap&lt;Node&lt;T&gt;&gt; map;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> T token;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.map = <span class="keyword">new</span> HashCharMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 固定长度哈希表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Rose</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HashCharMap</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> LinkedPair&lt;V&gt;[] columns;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> LinkedPair&lt;V&gt;[] ends;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HashCharMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            columns = <span class="keyword">new</span> LinkedPair[CAPACITY];</span><br><span class="line">            ends = <span class="keyword">new</span> LinkedPair[CAPACITY];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">position</span><span class="params">(<span class="keyword">int</span> first)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Math.abs(first ^ (first &lt;&lt; <span class="number">6</span>) * ((first &amp; <span class="number">1</span>) != <span class="number">0</span> ? <span class="number">3</span> : <span class="number">1</span>)) % CAPACITY;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">char</span> first)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> position = position(first);</span><br><span class="line">            LinkedPair&lt;V&gt; pair = columns[position];</span><br><span class="line">            <span class="keyword">while</span>(pair != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(pair.first == first) &#123;</span><br><span class="line">                    <span class="keyword">return</span> pair.second;</span><br><span class="line">                &#125;</span><br><span class="line">                pair = pair.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> LinkedPair&lt;V&gt; <span class="title">get</span><span class="params">(<span class="keyword">char</span> first,<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">            LinkedPair&lt;V&gt; pair = columns[position];</span><br><span class="line">            <span class="keyword">while</span>(pair != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(pair.first == first) &#123;</span><br><span class="line">                    <span class="keyword">return</span> pair;</span><br><span class="line">                &#125;</span><br><span class="line">                pair = pair.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">char</span> first, V second)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> position = position(first);</span><br><span class="line">            <span class="keyword">if</span>(ends[position] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                columns[position] = ends[position] = <span class="keyword">new</span> LinkedPair&lt;&gt;();</span><br><span class="line">                ends[position].first = first;</span><br><span class="line">                ends[position].second = second;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            LinkedPair&lt;V&gt; p = get(first, position);</span><br><span class="line">            <span class="keyword">if</span>(p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                p = ends[position].next = <span class="keyword">new</span> LinkedPair&lt;&gt;();</span><br><span class="line">                ends[position] = p;</span><br><span class="line">            &#125;</span><br><span class="line">            p.first = first;</span><br><span class="line">            p.second = second;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 数据节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Rose</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedPair</span>&lt;<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> LinkedPair&lt;V&gt; next;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">char</span> first;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> V second;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<code>scanIdentifier()</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Tokens <span class="title">scanIdentifier</span><span class="params">(<span class="keyword">char</span> ch)</span> </span>&#123;</span><br><span class="line">    TrieTree.Node&lt;Tokens&gt; n = keywords.root.map.get(ch);</span><br><span class="line">    <span class="keyword">while</span> (offset + length &lt; bufferLen &amp;&amp; isIdentifierPart(ch = charAt(offset + length))) &#123;</span><br><span class="line">        length++;</span><br><span class="line">        n = n == <span class="keyword">null</span> ? <span class="keyword">null</span> : n.map.get(ch);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n == <span class="keyword">null</span> ? IDENTIFIER : (n.token == <span class="keyword">null</span> ? IDENTIFIER : n.token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是重新运行,我们发现效率高了不少,但是还是差JFLex不少,这是为什么呢?<br>这时,我别无推卸,只能认定自己的方法不行吗?<br>不.<br>这是,我们看向了用于识别标识符的两个方法.<br>我们用循环测试一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> start = System.currentMillis();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; str.length();i++) &#123;</span><br><span class="line">    Character.isIdenrifierPart(str.charAt(i));</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentMillis() - start);</span><br><span class="line">start = System.currentMillis();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; str.length();i++) &#123;</span><br><span class="line">    Character.isIdenrifierStart(str.charAt(i));</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentMillis() - start);</span><br><span class="line">start = System.currentMillis();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; str.length();i++) &#123;</span><br><span class="line">    str.charAt(i);</span><br><span class="line">    str.charAt(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentMillis() - start);</span><br></pre></td></tr></table></figure>
<p>结果发现:调用了<code>Character</code>的两个循环比不调用的时间多得多!<br>于是我们编写了自己测试是否标识符的方法,由于失败(很慢)了,这里不给出了.<br>编写的方法用的是一堆’||’连接来判断,比自带的慢得多.<br>我们猜想:<code>Character</code>的这两个方法的内部实现很有可能在native层,而且很有可能也是这样一堆’||’,所以很慢,但是比在Java中实现快.<br>于是我们采用空间换时间的办法再优化:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCharacter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span>[] state1,state2;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span>[] state3,state4;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(state1 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        state1 = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">35000</span>];</span><br><span class="line">        state2 = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">65536</span> - <span class="number">35000</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">35000</span>;i++) &#123;</span><br><span class="line">            state1[i] = Character.isJavaIdentifierPart((<span class="keyword">char</span>)i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">35000</span>;i &lt;= <span class="number">65535</span>;i++) &#123;</span><br><span class="line">            state2[i - <span class="number">35000</span>] = Character.isJavaIdentifierPart((<span class="keyword">char</span>)i);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        state3 = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">35000</span>];</span><br><span class="line">        state4 = <span class="keyword">new</span> <span class="keyword">boolean</span>[<span class="number">65536</span> - <span class="number">35000</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">35000</span>;i++) &#123;</span><br><span class="line">            state3[i] = Character.isJavaIdentifierStart((<span class="keyword">char</span>)i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">35000</span>;i &lt;= <span class="number">65535</span>;i++) &#123;</span><br><span class="line">            state4[i - <span class="number">35000</span>] = Character.isJavaIdentifierStart((<span class="keyword">char</span>)i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJavaIdentifierPart</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(key &lt; <span class="number">35000</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state1[key];</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> state2[key - <span class="number">35000</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJavaIdentifierStart</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(key &lt; <span class="number">35000</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state3[key];</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> state4[key - <span class="number">35000</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用之前记得调用<code>initMap()</code><br>我们在实际应用时想到:<code>boolean</code>只能保存一个状态却占用1字节空间,但是换成<code>int</code>就可以4个字节保存32个状态,大大压缩了空间<br>于是利用位运算,我们又写出了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCharacter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] state_start;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] state_part;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">get</span><span class="params">(<span class="keyword">int</span>[] values,<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((values[bitIndex / <span class="number">32</span>] &amp; (<span class="number">1</span> &lt;&lt; (bitIndex % <span class="number">32</span>))) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span>[] values,<span class="keyword">int</span> bitIndex)</span> </span>&#123;</span><br><span class="line">        values[bitIndex / <span class="number">32</span>] |= (<span class="number">1</span> &lt;&lt; (bitIndex % <span class="number">32</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(state_start != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        state_part = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2048</span>];</span><br><span class="line">        state_start = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2048</span>];</span><br><span class="line">        Arrays.fill(state_part,<span class="number">0</span>);</span><br><span class="line">        Arrays.fill(state_start,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt;= <span class="number">65535</span>;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(Character.isJavaIdentifierPart((<span class="keyword">char</span>) i)) &#123;</span><br><span class="line">                set(state_part,i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(Character.isJavaIdentifierStart((<span class="keyword">char</span>) i)) &#123;</span><br><span class="line">                set(state_start,i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJavaIdentifierPart</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(state_part,key);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isJavaIdentifierStart</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> get(state_start,key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就把空间压缩到了原来的1/8.<br>而词法分析器的速度更是大大提高,居然远超JFLex.</p>
<h2 id="升级Android部分"><a href="#升级Android部分" class="headerlink" title="升级Android部分"></a>升级Android部分</h2><p>就在我在各个QQ群里面水吹我的词法分析器时,有人开始催我更新编辑器了.<br>我已经在QQ群里面吹过多次我要写个高亮编辑器了,每一次都是半途而废,这一次他们戏称我”写了一年了”(因为上次提出要写编辑器已经是在上个寒假了)<br>我想了一想,写就写!反正之前已经完成了很多工作了,只是加个高亮而已,有什么好怕的!<br>加上此时新型冠状病毒肆虐,假期延长的通知发来了,第二期的补课取消已经是板上钉钉的事情了,怕个屁!直接开搞!<br>于是我又启动了凤凰OS.</p>
<h3 id="高亮分析"><a href="#高亮分析" class="headerlink" title="高亮分析"></a>高亮分析</h3><h4 id="初步"><a href="#初步" class="headerlink" title="初步"></a>初步</h4><p>只需要操作Tokenizer即可.<br>针对每一个Token添加对于的Span到List就好了<br>(Line,Column,Index)可以直接从Tokenizer/Content获取</p>
<h4 id="Span加速"><a href="#Span加速" class="headerlink" title="Span加速"></a>Span加速</h4><p>分析:我们添加Span,没有必要每个Token都添加.<br>因为我们并不是相邻的Token一定是不同的颜色.例如:多个关键字连接在一起<br>而且,WHITESPACE和NEWLINE我们根本不需要为之添加Span–他们根本看不见.<br>这样一来,我们定义了方法<code>addSpanIfNeeded()</code>,只在需要时添加Span,以免浪费内存空间,而且需要更多时间(List不断扩容)<br>这也可以加速绘制.</p>
<h4 id="charAt-加速"><a href="#charAt-加速" class="headerlink" title="charAt()加速"></a>charAt()加速</h4><p>由于词法分析几乎是流式地获取<code>char</code>,我们启用<code>CachedIndexer</code>加快速度.<br><code>AnalyzeThread</code>中的段落:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content copy = content.makeCopy();</span><br><span class="line">copy.beginStreamCharGetting(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>然后写出了<code>S5droidColorProvider</code>,实现<code>Analyzer</code>.<br>但是发现分析速度很慢,为什么呢?<br>把一切添加Span的操作注释,运行发现还是很慢,证明是charAt出了问题.<br>查看<code>CachedIndexer</code>,发现每次charAt都会造成新对象的产生,这就有问题了!<br>我们于是使得它在词法分析时只使用一个对象返回结果,果然快了不少,但是还是达不到我们理想的状态:20w在1s内分析完.<br>现在使用了大约3s.<br>于是我们更换LexIndexer:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LexIndexer</span> <span class="keyword">implements</span> <span class="title">Indexer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CharPosition pos;</span><br><span class="line">    <span class="keyword">private</span> Content content;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> line,column,index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> linecount;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LexIndexer</span><span class="params">(Content content)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">        index = line = column = <span class="number">0</span>;</span><br><span class="line">        pos = <span class="keyword">new</span> CharPosition();</span><br><span class="line">        linecount = content.getColumnCount(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Don&#x27;t need</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCharIndex</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">int</span> column)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Don&#x27;t need</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCharLine</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Don&#x27;t need</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCharColumn</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">forward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        index++;</span><br><span class="line">        column++;</span><br><span class="line">        <span class="keyword">if</span>(column == linecount + <span class="number">1</span>) &#123;</span><br><span class="line">            line++;</span><br><span class="line">            column = <span class="number">0</span>;</span><br><span class="line">            linecount = content.getColumnCount(line);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">backward</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        index--;</span><br><span class="line">        <span class="keyword">if</span>(column == <span class="number">0</span>) &#123;</span><br><span class="line">            line--;</span><br><span class="line">            linecount = column = content.getColumnCount(line);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            column--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharPosition <span class="title">getCharPosition</span><span class="params">(<span class="keyword">int</span> index0)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(index &lt; index0) forward();</span><br><span class="line">        <span class="keyword">while</span>(index &gt; index0) backward();</span><br><span class="line">        pos.column = column;</span><br><span class="line">        pos.line = line;</span><br><span class="line">        pos.index = index0;</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Don&#x27;t need</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CharPosition <span class="title">getCharPosition</span><span class="params">(<span class="keyword">int</span> line, <span class="keyword">int</span> column)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>果然,时间降下到2s左右了.<br>还是达不到我们的要求.<br>此时需要另辟蹊径.<br>我们尝试直接把<code>Content</code>给转换成一个<code>StringBuilder</code>(不<code>toString()</code>)了,然后直接操作这个StringBuilder对象,至于(Line,Column)的计算我们交给辅助类<code>LineNumberHelper</code>来做:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LineNumberHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CharSequence mTarget;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mOffset;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mLine;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mColumn;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mLength;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LineNumberHelper</span><span class="params">(CharSequence target)</span> </span>&#123;</span><br><span class="line">        mTarget = target;</span><br><span class="line">        mOffset = mLine = mColumn = <span class="number">0</span>;</span><br><span class="line">        mLength = mTarget.length();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; length;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(mOffset + i == mLength) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(mTarget.charAt(mOffset + i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                mLine++;</span><br><span class="line">                mColumn = <span class="number">0</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                mColumn++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mOffset = mOffset + length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLineStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mOffset - mColumn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLineEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(;i + mOffset &lt; mLength;i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(mTarget.charAt(mOffset + i) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mOffset + i;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLine</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mLine;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColumn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mColumn;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是我们惊喜地发现,时间降到800ms左右了!<br>而且纯词法分析也只有200ms!</p>
<h3 id="绘制加速-二分法的应用"><a href="#绘制加速-二分法的应用" class="headerlink" title="绘制加速 - 二分法的应用"></a>绘制加速 - 二分法的应用</h3><p>我们在上面的Span寻址中,使用的是顺序查找的方法,顺序查找的时间复杂度是O(N).在我们Span比较少的时候可以很快地找到地址,但是如果我们的Span很多的时候((比如用户滑动到20万行),这个时候第一次寻找地址的时间就会很长.<br>经过测试,每行大约5个Span时,滑动到20w行之后,绘制时间大约在20ms,这显然远远高出了16ms的要求.这时我们就要请出我们的好朋友<code>二分法(Binary Search)</code>了.<br><code>Binary Search</code>是编程中常用的算法之一.必须在 ** 数据有序 ** 的时候使用.而Span的排列顺序显然服从这个规律(词法分析是从前向后的,所以Span的起始位置一定是服从从小到大排列的顺序的)<br>所以,如果我们在第一次寻址的时候使用二分法,后面接着前面查找出的结果使用顺序查找法,寻址速度可以大大提高.<br>于是,我们对<code>seekTo()</code>函数稍加修改.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Find for the start of line in spans</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> spans Spans</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> line Searching line</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> Start span index in spans</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(List&lt;Span&gt; spans, <span class="keyword">int</span> line)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> left = <span class="number">0</span>,right = spans.size() - <span class="number">1</span>,mid,row;</span><br><span class="line">       <span class="keyword">int</span> max = right;</span><br><span class="line">       <span class="keyword">while</span>(left &lt;= right)&#123;</span><br><span class="line">           mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">if</span>(mid &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">if</span>(mid &gt; max) <span class="keyword">return</span> max;</span><br><span class="line">           row = spans.get(mid).getLine();</span><br><span class="line">           <span class="keyword">if</span>(row == line) &#123;</span><br><span class="line">               <span class="keyword">return</span> mid;</span><br><span class="line">           &#125;<span class="keyword">else</span> <span class="keyword">if</span>(row &lt; line)&#123;</span><br><span class="line">               left = mid + <span class="number">1</span>;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               right = mid - <span class="number">1</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Math.max(<span class="number">0</span>,Math.min(left,max));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Find the first span for line by binary search</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> spans Spans</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> line Searching line</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> First span index</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">seekTo</span><span class="params">(List&lt;Span&gt; spans, <span class="keyword">int</span> line)</span></span>&#123;</span><br><span class="line">       <span class="keyword">int</span> curr = binarySearch(spans,line);</span><br><span class="line">       <span class="keyword">if</span>(curr &gt;= spans.size())&#123;</span><br><span class="line">           curr = spans.size() - <span class="number">1</span>;</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(curr &lt; <span class="number">0</span>)&#123;</span><br><span class="line">           curr = <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span>(curr &gt; <span class="number">0</span>)&#123;</span><br><span class="line">           Span span = spans.get(curr);</span><br><span class="line">           <span class="keyword">if</span>(span.getLine() &gt;= line)&#123;</span><br><span class="line">               curr--;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">           Span span = spans.get(curr);</span><br><span class="line">           <span class="keyword">if</span>(span.getLine() &lt; line &amp;&amp; curr + <span class="number">1</span> &lt; spans.size() &amp;&amp; (spans.get(curr + <span class="number">1</span>).getLine() &lt; line||(spans.get(curr + <span class="number">1</span>).getLine() == line &amp;&amp; spans.get(curr + <span class="number">1</span>).getColumn() == <span class="number">0</span>)) ) &#123;</span><br><span class="line">               curr++;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> Math.min(curr,spans.size() - <span class="number">1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Find first span for the given line</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> spans Spans</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> line Searching line</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> curr Current index</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> New position</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">seekTo</span><span class="params">(List&lt;Span&gt; spans, <span class="keyword">int</span> line,<span class="keyword">int</span> curr)</span></span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(curr == <span class="number">0</span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> seekTo(spans,line);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">while</span>(curr &lt; spans.size()) &#123;</span><br><span class="line">           Span span = spans.get(curr);</span><br><span class="line">           <span class="keyword">if</span>(span.getLine() &lt; line &amp;&amp; curr + <span class="number">1</span> &lt; spans.size() &amp;&amp; (spans.get(curr + <span class="number">1</span>).getLine() &lt; line||(spans.get(curr + <span class="number">1</span>).getLine() == line &amp;&amp; spans.get(curr + <span class="number">1</span>).getColumn() == <span class="number">0</span>)))&#123;</span><br><span class="line">               curr++;</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> curr;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>为了保证结果的正确,这里用了两个while循环.<br>如果** 你 **觉得不用也可以去掉.<br>我们惊喜地发现,绘制速度已经下降到3-4ms了!<br><em><strong>特别提示:代码区划线的绘制只有末尾符合二分法的要求,开头的Index不是严格递增的!!!</strong></em></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>编辑框大致到这里就已经完成了,后面的工作是代码补全和代码区划线,也很简单.<br>同样是利用二分法加速了代码区划线的绘制,以及一个SuppressSwitch上限来控制寻找上限(这是由代码块的性质决定的).<br>自动补全只需要生成一颗代码块树就能实现了,然后递归操作即可,这里也不多讲了.<br>关键是我们在构建编辑框的同时,对二分法的应用以及数据结构TrieTree的应用有了更多更广的认识,这对于我们的开发是很有帮助的.</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Rose2073/CodeEditor">本项目仓库地址</a> (如果你喜欢本项目,请<strong>Star</strong>它吧QAQ)</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nirenr/AndroLua_pro">AndroLua+项目地址</a><br>对我有启发的项目:</li>
<li><a target="_blank" rel="noopener" href="https://github.com/CaoHaoFeng/CodeEditorView">CodeEditView</a><br>虽然只是一个能显示行号的输入框而已<br>不过按行保存文本的念头最初是从这里来的.应该是几年前贴吧里面的一个项目吧.当时觉得这个主意非常棒,就记下来了.<br>也不知道这个是不是原来那个项目了.不过看中文注释应该是了吧.</li>
<li>后记：<a target="_blank" rel="noopener" href="https://github.com/summerain0/CodeEditorView">CodeEditView</a><br>找到了，就是这个链接了，原来在我QQ收藏里面躺着。不过貌似已经被删除了呢……</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Rosemoe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://rosemoe.github.io/2020/02/15/highlight-editor-creation/">https://rosemoe.github.io/2020/02/15/highlight-editor-creation/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/%E8%87%AA%E5%AE%9A%E4%B9%89View/">自定义View</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/09/NOI-Online-fxxk/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">NOI Online爆零记</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/15/hello-world/"><img class="next-cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Hello World</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2020/04/25/android-dev-mistake/" title="记Android开发中一个坑 - ViewRootImpl"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-25</div><div class="title">记Android开发中一个坑 - ViewRootImpl</div></div></a></div><div><a href="/2021/10/02/android-render-node-using/" title="使用Android RenderNode加速绘制"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-02</div><div class="title">使用Android RenderNode加速绘制</div></div></a></div><div><a href="/2020/10/30/image-to-qq-painting/" title="👴玩爆QQ涂鸦"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-30</div><div class="title">👴玩爆QQ涂鸦</div></div></a></div><div><a href="/2020/08/24/what-is-slow-in-text-warrior/" title="Text Warrior中一些不足之处"><img class="cover" src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-08-24</div><div class="title">Text Warrior中一些不足之处</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-lazy-src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Rosemoe</div><div class="author-info__description">A lazy Android developer</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">8</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Rosemoe"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Rosemoe" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2073412493@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">Welcome to Rosemoe's Blog ~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.</span> <span class="toc-text">制作背景</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%B0%9D%E8%AF%95-Editable"><span class="toc-number">1.1.1.</span> <span class="toc-text">第一次尝试 - Editable</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">过程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BC%8A%E7%AB%AF"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">弊端</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%B0%9D%E8%AF%95-%E8%87%AA%E5%AE%9A%E4%B9%89View%E7%9A%84%E5%BC%80%E7%AB%AF"><span class="toc-number">1.2.</span> <span class="toc-text">第二次尝试 - 自定义View的开端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BF%BB%E7%9C%8B%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE"><span class="toc-number">1.2.1.</span> <span class="toc-text">翻看开源项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AD%E9%97%A8%E9%80%A0%E8%BD%A6"><span class="toc-number">1.2.2.</span> <span class="toc-text">闭门造车</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AC%A1%E5%B0%9D%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">第三次尝试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E7%BB%8F%E9%AA%8C"><span class="toc-number">1.4.</span> <span class="toc-text">总结经验</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%BC%80%E7%AB%AF"><span class="toc-number">2.</span> <span class="toc-text">本项目的开端</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E8%A1%8C%E4%BF%9D%E5%AD%98%E6%96%87%E6%9C%AC"><span class="toc-number">2.1.</span> <span class="toc-text">按行保存文本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0Index-lt-gt-Line-Column-%E7%9A%84%E5%8F%98%E6%8D%A2"><span class="toc-number">2.2.</span> <span class="toc-text">实现Index&lt;-&gt;(Line,Column)的变换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Undo%E5%92%8CRedo"><span class="toc-number">2.3.</span> <span class="toc-text">Undo和Redo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E6%9E%84Android"><span class="toc-number">3.</span> <span class="toc-text">初构Android</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%9C%AC%E7%BB%98%E5%88%B6%E5%92%8C%E5%9F%BA%E6%9C%AC%E4%BA%A4%E4%BA%92"><span class="toc-number">3.1.</span> <span class="toc-text">文本绘制和基本交互</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%98%E5%88%B6%E7%9A%84%E5%9D%91"><span class="toc-number">3.1.1.</span> <span class="toc-text">绘制的坑</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%98%E5%88%B6%E8%A1%8C%E5%8F%B7"><span class="toc-number">3.1.2.</span> <span class="toc-text">绘制行号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.3.</span> <span class="toc-text">滚动操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5%E7%BB%98%E5%88%B6%E6%96%87%E6%9C%AC"><span class="toc-number">3.1.4.</span> <span class="toc-text">初步绘制文本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%BE%93%E5%85%A5%E5%92%8C%E5%88%A0%E9%99%A4"><span class="toc-number">3.1.5.</span> <span class="toc-text">实现输入和删除</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A%E6%B8%B8%E6%A0%87"><span class="toc-number">3.1.6.</span> <span class="toc-text">设定游标</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.2.</span> <span class="toc-text">小结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%96%87%E6%9C%AC"><span class="toc-number">3.3.</span> <span class="toc-text">高亮文本</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%98%E5%88%B6Spans"><span class="toc-number">3.3.1.</span> <span class="toc-text">绘制Spans</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">词法分析器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%8D%95%E8%AF%8D"><span class="toc-number">4.1.</span> <span class="toc-text">定义单词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">4.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96"><span class="toc-number">4.4.</span> <span class="toc-text">优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7Android%E9%83%A8%E5%88%86"><span class="toc-number">5.</span> <span class="toc-text">升级Android部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">高亮分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E6%AD%A5"><span class="toc-number">5.1.1.</span> <span class="toc-text">初步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Span%E5%8A%A0%E9%80%9F"><span class="toc-number">5.1.2.</span> <span class="toc-text">Span加速</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#charAt-%E5%8A%A0%E9%80%9F"><span class="toc-number">5.1.3.</span> <span class="toc-text">charAt()加速</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%98%E5%88%B6%E5%8A%A0%E9%80%9F-%E4%BA%8C%E5%88%86%E6%B3%95%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">绘制加速 - 二分法的应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-number">6.</span> <span class="toc-text">结语</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="toc-number">7.</span> <span class="toc-text">相关链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/07/23/atcoder-abc310/" title="AtCoder Beginner Contest 310 A-F 题解">AtCoder Beginner Contest 310 A-F 题解</a><time datetime="2023-07-23T13:34:35.000Z" title="Created 2023-07-23 21:34:35">2023-07-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/24/whut-2022-autumn-c-answer/" title="WHUT2022秋C语言A类答案">WHUT2022秋C语言A类答案</a><time datetime="2022-10-24T09:45:05.000Z" title="Created 2022-10-24 17:45:05">2022-10-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/10/02/android-render-node-using/" title="使用Android RenderNode加速绘制">使用Android RenderNode加速绘制</a><time datetime="2021-10-02T11:57:08.000Z" title="Created 2021-10-02 19:57:08">2021-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/22/editor-get-started/" title="Sora-editor - Get started">Sora-editor - Get started</a><time datetime="2021-08-22T05:58:06.000Z" title="Created 2021-08-22 13:58:06">2021-08-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2020/10/30/image-to-qq-painting/" title="👴玩爆QQ涂鸦">👴玩爆QQ涂鸦</a><time datetime="2020-10-30T09:57:33.000Z" title="Created 2020-10-30 17:57:33">2020-10-30</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Rosemoe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">にゃん~</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.css"><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script id="canvas_nest" defer="defer" color="255,0,0" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/click-show-text.min.js" data-mobile="true" data-text="にゃん~" data-fontsize="15px" data-random="true" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>